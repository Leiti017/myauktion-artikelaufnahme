<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MyAuktion Â· Artikelaufnahme</title>
  <link rel="icon" type="image/x-icon" href="/static/my_icon.ico">
  <!-- iOS / Android Home-Screen Icons -->
  <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
  <link rel="manifest" href="/static/site.webmanifest">
  <meta name="theme-color" content="#1d4ed8">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="MyAuktion">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">

  <script defer src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { color-scheme: light dark; }
    body {
      min-height: 100vh;
      background:
        radial-gradient(1200px 600px at 80% -10%, #e7f1ff 0%, transparent 60%),
        linear-gradient(135deg, #0ea5e9 0%, #1d4ed8 60%, #1e293b 100%);
    }
    .glass {
      background: rgba(255,255,255,0.08);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.15);
    }
    .btn {
      padding:.55rem 1.1rem;
      border-radius:999px;
      font-weight:600;
      transition:.15s;
      display:inline-flex;
      align-items:center;
      gap:.45rem;
      white-space:nowrap;
    }
    .btn:hover { opacity:.95; transform: translateY(-1px); }
    .btn-primary {
      background:#fff;
      color:#0f172a;
      box-shadow:0 8px 30px rgba(0,0,0,.15);
    }
    .btn-ghost {
      color:#fff;
      border:1px solid rgba(255,255,255,.35);
      background:transparent;
    }
    .input, select {
      width:100%;
      border-radius:.75rem;
      padding:.55rem .9rem;
      background:rgba(255,255,255,.96);
      color:#0f172a;
      outline:none;
      border:1px solid transparent;
      font-size:.9rem;
    }
    .input:focus, select:focus, textarea:focus {
      box-shadow:0 0 0 3px rgba(59,130,246,.35);
      border-color:rgba(255,255,255,.85);
    }
    textarea {
      width:100%;
      min-height:140px;
      border-radius:.75rem;
      padding:.6rem .9rem;
      background:rgba(255,255,255,.96);
      color:#0f172a;
      outline:none;
      border:1px solid transparent;
      font-size:.9rem;
      resize:vertical;
    }
    .thumb {
      border-radius:1rem;
      border:1px dashed rgba(255,255,255,.4);
      min-height:180px;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      background:rgba(15,23,42,.35);
      cursor:pointer;
    }
    .thumb img {
      max-width:100%;
      max-height:100%;
      display:block;
    }
    .img-strip img {
      height:58px;
      border-radius:.75rem;
      border:1px solid rgba(255,255,255,.3);
      cursor:pointer;
    }
    .status-pill {
      font-size:.75rem;
      padding:.2rem .6rem;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.3);
      display:inline-flex;
      align-items:center;
      gap:.3rem;
    }
    .status-pill-dot {
      width:7px;
      height:7px;
      border-radius:999px;
      background:#22c55e;
    }
    .toast-wrap {
      position:fixed;
      top:12px;
      right:12px;
      z-index:50;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .toast {
      color:#0f172a;
      background:#fff;
      border-radius:999px;
      padding:7px 12px;
      font-weight:600;
      box-shadow:0 10px 30px rgba(0,0,0,.18);
      opacity:0;
      transform:translateY(-6px) scale(.94);
      transition:.18s ease;
      font-size:.8rem;
    }
    .toast.show {
      opacity:1;
      transform:translateY(0) scale(1);
    }
  </style>
</head>
<body class="text-white">
  <div id="toast-wrap" class="toast-wrap"></div>

  <div class="max-w-5xl mx-auto px-4 py-5 md:py-8">
    <!-- HEADER -->
    <header class="flex items-center justify-between gap-4 mb-6">
      <div class="flex items-center gap-3">
        <div class="w-11 h-11 rounded-full bg-white shadow-lg flex items-center justify-center overflow-hidden">
          <img src="/static/myauktion_logo.png" alt="MyAuktion" class="max-w-[34px] max-h-[34px]">
        </div>
        <div>
          <div class="text-xl md:text-2xl font-bold tracking-tight flex items-center gap-1">
            MyAuktion
            <span class="text-sm font-semibold opacity-90">Â· Artikelaufnahme</span>
          </div>
          <div class="text-xs md:text-sm text-white/80">
            BEI UNS BESTIMMST DU DEN PREIS!
          </div>
        </div>
      </div>
      <div class="hidden sm:flex items-center gap-3">
        <div class="px-3 py-1 rounded-full text-xs glass flex items-center gap-2">
          <span class="w-2 h-2 rounded-full bg-red-500"></span>
          <span>500+ Artikel pro Tag</span>
        </div>
      </div>
    </header>

    <!-- MAIN -->
    <main class="glass rounded-3xl p-4 md:p-6 shadow-xl">
      <div class="grid md:grid-cols-2 gap-5">
        <!-- LINKES PANEL: Stammdaten + Foto -->
        <section>
          <div class="flex items-center justify-between mb-3">
            <div>
              <h2 class="text-lg font-semibold">1. Artikel erfassen</h2>
              <p class="text-xs text-white/80">
                Artikelnummer, Einlieferer, Lagerort & Foto.
              </p>
            </div>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
            <div>
              <label class="block mb-1 text-xs opacity-80">Artikelnummer</label>
              <input id="f-artikelnr" type="number" inputmode="numeric" class="input" autocomplete="off">
              <p class="text-[11px] text-white/70 mt-1">
                Nach dem Speichern wird automatisch +1 eingetragen.
              </p>
            </div>
            <div>
              <label class="block mb-1 text-xs opacity-80">Lagerort</label>
              <input id="f-lagerort" type="text" class="input" placeholder="z.B. (22) Haushalt/Freizeit 170">
              <p class="text-[11px] text-white/70 mt-1">
                Bleibt fÃ¼r die nÃ¤chsten Artikel erhalten.
              </p>
            </div>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
            <div>
              <label class="block mb-1 text-xs opacity-80">Einlieferer-ID</label>
              <select id="f-einlieferer" class="input">
                <option value="22" selected>22</option>
                <option value="55">55</option>
                <option value="66">66</option>
                <option value="65461">65461</option>
              </select>
            </div>
            <div>
              <label class="block mb-1 text-xs opacity-80">Mitarbeiter</label>
              <select id="f-mitarbeiter" class="input">
                <option value="Jan">Jan</option>
                <option value="Rene">Rene</option>
                <option value="Karin">Karin</option>
                <option value="Katharina">Katharina</option>
                <option value="Linda">Linda</option>
                <option value="Jasmin">Jasmin</option>
              </select>
            </div>
          </div>

          <!-- verstecktes File-Input (nur per Klick auf Bild/ Button) -->
          <input id="f-file" type="file" accept="image/*" capture="environment" class="hidden">

          <!-- Bild-Vorschau: klickbar zum Foto auswÃ¤hlen -->
          <div class="thumb mb-2" id="thumb">
            <span class="text-xs text-white/70 text-center">
              Hier tippen, um ein Foto aufzunehmen / auszuwÃ¤hlen.
            </span>
          </div>
          <div class="img-strip flex gap-2 overflow-x-auto pb-1" id="img-strip"></div>

          <!-- Buttons: Foto auswÃ¤hlen + Speichern -->
          <div class="flex flex-col gap-2 mt-3">
            <button id="btn-photo" class="btn btn-primary text-sm">
              <i data-lucide="camera" class="w-4 h-4"></i>
              <span>ðŸ“¸ Foto auswÃ¤hlen</span>
            </button>
            <button id="btn-save" class="btn btn-ghost text-sm">
              <i data-lucide="save" class="w-4 h-4"></i>
              <span>ðŸ’¾ Artikel speichern</span>
            </button>
          </div>

          <p class="text-[11px] text-white/70 mt-2">
            Foto auswÃ¤hlen lÃ¤dt automatisch hoch. Danach berechnet die KI einen Vorschlag,
            den du direkt hier siehst. Artikel speichern legt alles ab und setzt die nÃ¤chste Artikelnummer (+1).
          </p>
        </section>

        <!-- RECHTES PANEL: Text + Status -->
        <section>
          <div class="flex items-center justify-between mb-3">
            <div>
              <h2 class="text-lg font-semibold">2. Titel & Beschreibung</h2>
              <p class="text-xs text-white/80">
                KI-Vorschlag kontrollieren oder Text selbst eingeben.
              </p>
            </div>
            <button id="btn-describe" class="btn btn-ghost text-xs">
              âš¡ KI neu berechnen (optional)
            </button>
          </div>

          <div class="mb-3">
            <label class="block mb-1 text-xs opacity-80">Bezeichnung</label>
            <input id="f-title" type="text" class="input" autocomplete="off">
          </div>

          <div class="mb-3">
            <label class="block mb-1 text-xs opacity-80">Beschreibung</label>
            <textarea id="f-desc"></textarea>
          </div>

          <div class="flex items-center justify-between gap-2 mb-3">
            <div id="status-text" class="text-[11px] text-white/80">
              Noch nicht gespeichert.
            </div>
            <div id="status-pill" class="status-pill hidden">
              <span class="status-pill-dot"></span>
              <span>Text aus KI-Batch</span>
            </div>
          </div>

          <div>
            <label class="block mb-1 text-xs opacity-80">System-Log</label>
            <div id="log" class="text-[11px] text-slate-900 bg-white/90 rounded-xl p-2 max-h-32 overflow-y-auto"></div>
          </div>
        </section>
      </div>
    </main>

    <footer class="mt-5 flex flex-col md:flex-row items-center justify-between gap-2 text-xs text-white/80">
      <div class="flex items-center gap-2">
        <i data-lucide="gavel" class="w-4 h-4"></i>
        <span>Programmiert von Jan Leitinger / Leiti017</span>
      </div>
      <div class="flex items-center gap-1">
        <a href="https://www.myauktion.com" target="_blank" rel="noreferrer" class="underline">www.myauktion.com</a>
        <span>Â·</span>
        <a href="https://www.goldgrube.at" target="_blank" rel="noreferrer" class="underline">www.goldgrube.at</a>
      </div>
    </footer>
  </div>

  <script>
    const fArt   = document.getElementById('f-artikelnr');
    const fLager = document.getElementById('f-lagerort');
    const fEinl  = document.getElementById('f-einlieferer');
    const fMit   = document.getElementById('f-mitarbeiter');
    const fFile  = document.getElementById('f-file');
    const thumb  = document.getElementById('thumb');
    const imgStrip = document.getElementById('img-strip');
    const fTitle = document.getElementById('f-title');
    const fDesc  = document.getElementById('f-desc');
    const statusText = document.getElementById('status-text');
    const statusPill = document.getElementById('status-pill');
    const logEl  = document.getElementById('log');
    const toastWrap = document.getElementById('toast-wrap');

    const btnPhoto    = document.getElementById('btn-photo');
    const btnDescribe = document.getElementById('btn-describe');
    const btnSave     = document.getElementById('btn-save');

    const defaultThumbHtml =
      '<span class="text-xs text-white/70 text-center">Hier tippen, um ein Foto aufzunehmen / auszuwÃ¤hlen.</span>';

    function log(msg) {
      const time = new Date().toLocaleTimeString();
      const div = document.createElement('div');
      div.textContent = '[' + time + '] ' + msg;
      logEl.prepend(div);
    }

    function showToast(msg) {
      const el = document.createElement('div');
      el.className = 'toast';
      el.textContent = msg;
      toastWrap.appendChild(el);
      void el.offsetWidth;
      el.classList.add('show');
      setTimeout(() => {
        el.classList.remove('show');
        setTimeout(() => el.remove(), 200);
      }, 1600);
    }

    function parseIntSafe(v) {
      const n = parseInt(v, 10);
      return Number.isFinite(n) ? n : null;
    }

    function prepareNextArtNr() {
      const current = fArt.value.trim();
      const n = parseIntSafe(current);
      if (n === null) return;
      fArt.value = String(n + 1);
      statusText.textContent = 'NÃ¤chste Artikelnummer vorbereitet: ' + (n + 1);
      statusPill.classList.add('hidden');
      // Text & Datei/Bild zurÃ¼cksetzen, Lagerort/EINL/Mitarbeiter bleiben
      fTitle.value = '';
      fDesc.value = '';
      fFile.value = '';
      thumb.innerHTML = defaultThumbHtml;
      imgStrip.innerHTML = '';
      log('NÃ¤chster Artikel: ' + (n + 1));
    }

    async function refreshImages() {
      const art = fArt.value.trim();
      if (!art) return;
      try {
        const res = await fetch('/api/images?artikelnr=' + encodeURIComponent(art));
        const j = await res.json();
        imgStrip.innerHTML = '';
        if (!j.ok || !j.files || !j.files.length) return;
        j.files.forEach(url => {
          const img = document.createElement('img');
          img.src = url;
          img.addEventListener('click', () => {
            thumb.innerHTML = '';
            const big = document.createElement('img');
            big.src = url;
            thumb.appendChild(big);
          });
          imgStrip.appendChild(img);
        });
      } catch (e) {
        console.error(e);
      }
    }

    async function initNextArtNr() {
      try {
        const res = await fetch('/api/next_artikelnr');
        const j = await res.json();
        if (res.ok && j.ok && j.next) {
          fArt.value = String(j.next);
          statusText.textContent = 'Vorgeschlagene Artikelnummer: ' + j.next;
          log('Vorgeschlagene Artikelnummer: ' + j.next);
        }
      } catch (e) {
        console.error(e);
      }
    }

    // Artikelnummer blur -> prÃ¼fen ob es schon Bilder + Meta gibt
    fArt.addEventListener('blur', async () => {
      const art = fArt.value.trim();
      if (!art) return;

      try {
        // 1) check_artnr -> gibt Auskunft ob schon Bilder existieren
        const resCheck = await fetch('/api/check_artnr?artikelnr=' + encodeURIComponent(art));
        const jCheck = await resCheck.json();

        if (resCheck.ok && jCheck.ok && jCheck.exists) {
          statusText.textContent = 'Artikelnummer existiert bereits â€“ Bilder & Daten werden ergÃ¤nzt.';
          await refreshImages();
        } else {
          statusText.textContent = 'Neue Artikelnummer.';
          imgStrip.innerHTML = '';
          thumb.innerHTML = defaultThumbHtml;
        }

        // 2) meta -> vorhandene KI-/Manuell-Texte holen
        const resMeta = await fetch('/api/meta?artikelnr=' + encodeURIComponent(art));
        const jMeta = await resMeta.json();

        if (resMeta.ok && jMeta.ok) {
          if (jMeta.titel) fTitle.value = jMeta.titel;
          if (jMeta.beschreibung) fDesc.value = jMeta.beschreibung;

          // Status-Pill abhÃ¤ngig von ki_source / reviewed
          if (jMeta.ki_source === 'batch') {
            statusPill.classList.remove('hidden');
            statusPill.querySelector('span:nth-child(2)').textContent = 'Text aus KI-Batch';
          } else if (jMeta.reviewed) {
            statusPill.classList.remove('hidden');
            statusPill.querySelector('span:nth-child(2)').textContent = 'Im BÃ¼ro geprÃ¼ft';
          } else {
            statusPill.classList.add('hidden');
          }
        }
      } catch (e) {
        console.error(e);
      }
    });

    // Foto wÃ¤hlen â€“ sowohl Klick auf Vorschaubox als auch auf Button
    function triggerPhotoSelect() {
      fFile.click();
    }
    thumb.addEventListener('click', triggerPhotoSelect);
    btnPhoto.addEventListener('click', triggerPhotoSelect);

    // Wenn Datei ausgewÃ¤hlt wurde -> automatisch hochladen + Vorschau anzeigen + KI holen
    fFile.addEventListener('change', async () => {
      const art = fArt.value.trim();
      if (!art) {
        alert('Bitte zuerst eine Artikelnummer eingeben.');
        fFile.value = '';
        return;
      }
      if (!fFile.files.length) return;

      const file = fFile.files[0];
      const fd = new FormData();
      fd.append('file', file);
      fd.append('artikelnr', art);

      log('Upload fÃ¼r Artikel ' + art + ' gestartet â€¦');

      try {
        const res = await fetch('/api/upload', { method: 'POST', body: fd });
        const j = await res.json();
        if (!res.ok || !j.ok) {
          alert('Fehler beim Upload: ' + (j.error || res.status));
          log('Upload-Fehler.');
          return;
        }

        // Thumbnail lokal anzeigen
        const reader = new FileReader();
        reader.onload = ev => {
          thumb.innerHTML = '';
          const img = document.createElement('img');
          img.src = ev.target.result;
          thumb.appendChild(img);
        };
        reader.readAsDataURL(file);

        await refreshImages();

        statusText.textContent = 'Bild hochgeladen â€“ KI-Vorschlag wird berechnet â€¦';
        statusPill.classList.add('hidden');
        log('Bild fÃ¼r Artikel ' + art + ' hochgeladen.');
        showToast('Bild hochgeladen');

    // MANUELLE KI-BESCHREIBUNG (optional, falls man spÃ¤ter nochmal will)
    btnDescribe.addEventListener('click', async () => {
      const art = fArt.value.trim();
      if (!art) {
        alert('Bitte zuerst eine Artikelnummer eingeben.');
        return;
      }
      statusText.textContent = 'Manuelle KI-Berechnung lÃ¤uft â€¦';
      log('Manuelle KI-Berechnung fÃ¼r Artikel ' + art + ' â€¦');

      try {
        const res = await fetch('/api/describe?artikelnr=' + encodeURIComponent(art));
        const j = await res.json();
        if (!res.ok || !j.ok) {
          alert('Fehler bei KI-Berechnung: ' + (j.error || res.status));
          statusText.textContent = 'Fehler bei manueller KI-Berechnung.';
          log('KI-Fehler.');
          return;
        }
        fTitle.value = j.title || '';
        fDesc.value  = j.description || '';
        statusText.textContent = 'Manueller KI-Vorschlag eingetragen.';
        statusPill.classList.add('hidden');
        log('KI-Vorschlag fÃ¼r Artikel ' + art + ' Ã¼bernommen.');
        showToast('KI-Vorschlag Ã¼bernommen');
      } catch (e) {
        console.error(e);
        alert('Serverfehler bei KI-Berechnung.');
        statusText.textContent = 'Serverfehler bei manueller KI-Berechnung.';
        log('Serverfehler bei KI.');
      }
    });

    // SPEICHERN -> und danach automatisch +1 Artikelnummer
    btnSave.addEventListener('click', async () => {
      const art = fArt.value.trim();
      if (!art) {
        alert('Bitte Artikelnummer eingeben.');
        return;
      }
      const payload = {
        artikelnr: art,
        lagerort: fLager.value.trim(),
        einlieferer: fEinl.value,
        mitarbeiter: fMit.value,
        titel: fTitle.value.trim() || ('Artikel ' + art),
        beschreibung: fDesc.value.trim(),
        reviewed: false
      };
      log('Speichere Artikel ' + art + ' â€¦');
      try {
        const res = await fetch('/api/save', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const j = await res.json();
        if (!res.ok || !j.ok) {
          alert('Fehler beim Speichern: ' + (j.error || res.status));
          log('Fehler beim Speichern.');
          return;
        }
        statusText.textContent = 'Artikel gespeichert (noch nicht vom BÃ¼ro geprÃ¼ft).';
        statusPill.classList.add('hidden');
        log('Artikel ' + art + ' gespeichert.');
        showToast('Artikel ' + art + ' gespeichert');
        prepareNextArtNr();   // direkt nÃ¤chste Nummer setzen
      } catch (e) {
        console.error(e);
        alert('Serverfehler beim Speichern.');
        statusText.textContent = 'Serverfehler beim Speichern.';
        log('Serverfehler beim Speichern.');
      }
    });

    // Icons initialisieren + erste Artikelnummer holen
    window.addEventListener('DOMContentLoaded', () => {
      if (window.lucide) lucide.createIcons();
      initNextArtNr();
    });
  </script>
</body>
</html>
