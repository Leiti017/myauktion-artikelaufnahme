<!doctype html>
<html lang="de">
<head>
  <!-- build:NEXT_ARTICLE_20251215_193134 -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>MyAuktion ¬∑ Artikelaufnahme</title>

<!-- FAVICONS & APP ICONS -->
<link rel="icon" href="/static/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">

<link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">

<link rel="icon" type="image/png" sizes="192x192" href="/static/android-chrome-192x192.png">
<link rel="icon" type="image/png" sizes="512x512" href="/static/android-chrome-512x512.png">

<meta name="theme-color" content="#1d4ed8">

  <script defer src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root { color-scheme: light dark; }
    body{
      min-height:100vh;
      background:
        radial-gradient(1200px 600px at 80% -10%, #e7f1ff 0%, transparent 60%),
        linear-gradient(135deg,#0ea5e9,#1d4ed8 60%,#1e293b);
      color:#fff;
    }
    .glass{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.16);backdrop-filter:blur(12px)}
    .btn{padding:.55rem 1rem;border-radius:999px;font-weight:700;display:inline-flex;align-items:center;gap:.45rem}
    .btn-primary{background:#fff;color:#0f172a;box-shadow:0 8px 18px rgba(0,0,0,.2)}
    .btn-ghost{color:#fff;border:1px solid rgba(255,255,255,.35);background:transparent}
    .btn-danger{color:#fff;border:1px solid rgba(239,68,68,.85);background:rgba(239,68,68,.22)}
    .input, select{
      width:100%;padding:.55rem .9rem;border-radius:.75rem;background:rgba(255,255,255,.96);
      color:#0f172a;outline:none;border:1px solid transparent;font-size:.9rem
    }
    textarea{
      width:100%;min-height:140px;padding:.6rem .9rem;border-radius:.75rem;
      background:rgba(255,255,255,.96)!important;color:#0f172a!important;
      outline:none;border:1px solid transparent;font-size:.9rem;resize:vertical
    }
    .thumb{
      border-radius:1rem;border:1px dashed rgba(255,255,255,.4);
      min-height:190px;display:flex;align-items:center;justify-content:center;
      overflow:hidden;background:rgba(15,23,42,.35);cursor:pointer
    }
    .thumb img{max-width:100%;max-height:100%;display:block}
    .img-strip img{height:58px;border-radius:.75rem;border:1px solid rgba(255,255,255,.3);cursor:pointer}
    .pill{font-size:.75rem;padding:.2rem .6rem;border-radius:999px;border:1px solid rgba(255,255,255,.3);display:inline-flex;gap:.3rem;align-items:center}
    .dot{width:7px;height:7px;border-radius:999px;background:#22c55e}
    .toast-wrap{position:fixed;top:12px;right:12px;z-index:50;display:flex;flex-direction:column;gap:8px}
    .toast{background:#fff;color:#0f172a;border-radius:999px;padding:7px 12px;font-weight:700;box-shadow:0 10px 30px rgba(0,0,0,.18);opacity:0;transform:translateY(-6px) scale(.94);transition:.18s}
    .toast.show{opacity:1;transform:translateY(0) scale(1)}
    .price-off{border:2px solid rgba(239,68,68,.9)!important;background:rgba(254,242,242,.95)!important}
  
/* Save confirmation pulse */
@keyframes savePulse { 0% { transform: scale(1); } 40% { transform: scale(1.03); } 100% { transform: scale(1); } }
.save-pulse { animation: savePulse 0.6s ease-out; }
#photo-count{ display:inline-flex; align-items:center; gap:.4rem; padding:.25rem .5rem; border-radius:999px; border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.25); }
</style>
</head>

<body class="text-white">
<div id="toast-wrap" class="toast-wrap"></div>

<div class="max-w-5xl mx-auto px-4 py-5 md:py-8">
  <header class="flex items-center justify-between gap-4 mb-6">
    <div class="flex items-center gap-3">
      <div class="w-11 h-11 rounded-full bg-white shadow-lg flex items-center justify-center overflow-hidden">
        <img src="/static/myauktion_logo.png" alt="MyAuktion" class="max-w-[34px] max-h-[34px]" onerror="this.style.display=\'none\'; this.parentElement.innerHTML=\'<span class=&quot;text-slate-900 font-black&quot;>MG</span>\'">
      </div>
      <div>
        <div class="text-xl md:text-2xl font-bold tracking-tight flex items-center gap-2">
          MyAuktion <span class="text-sm font-semibold opacity-90">¬∑ Artikelaufnahme</span>
        </div>
        <div class="text-xs md:text-sm text-white/80">BEI UNS BESTIMMST DU DEN PREIS!</div>
      </div>
    </div>
    <div class="flex items-center gap-4 text-sm opacity-90"><a href="/admin" class="underline">Admin</a> </div>
  </header>

  <main class="glass rounded-3xl p-4 md:p-6 shadow-xl">
    <div class="grid md:grid-cols-2 gap-5">
      <!-- LINKS -->
      <section>
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-lg font-semibold">1. Artikel erfassen</h2>
          <button id="btn-settings" type="button" class="btn btn-ghost text-xs">‚öôÔ∏è Einstellungen</button>
        </div>

        <!-- ‚öôÔ∏è EINSTELLUNGEN -->
        <div id="settings-panel" class="glass rounded-2xl p-3 mb-3 hidden">
          <div class="text-[11px] text-white/80 mb-2">
            Startwerte (werden gespeichert und bei jedem Artikel automatisch √ºbernommen)
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
              <label class="block mb-1 text-xs opacity-80">Einlieferer-ID</label>
              <select id="s-einlieferer-id" class="input">
                <option value="22" selected>22</option>
                <option value="55">55</option>
                <option value="66">66</option>
                <option value="65461">65461</option>
              </select>
            </div>

            <div>
              <label class="block mb-1 text-xs opacity-80">Mitarbeiter</label>
              <select id="s-mitarbeiter" class="input">
                <option>Jan</option><option>Rene</option><option>Karin</option><option>Katharina</option>
                <option>Linda</option><option>Jasmin</option><option>Natascha</option><option>Gast1</option><option>Gast2</option><option>Gast3</option>
              </select>
            </div>
            <div>
              <label class="block mb-1 text-xs opacity-80">Sortiment</label>
              <select id="s-sortiment" class="input">
                <option value="">(kein Sortiment)</option>
              </select>
            </div>
            <div>
              <label class="block mb-1 text-xs opacity-80">Lagerstand</label>
              <input id="s-lagerstand" type="number" class="input" value="1" min="1">
            </div>

            <div>
              <label class="block mb-1 text-xs opacity-80">√úbernehmen</label>
              <input id="s-uebernehmen" type="number" class="input" value="1" min="0">
            </div>

            <div>
              <label class="block mb-1 text-xs opacity-80">Angeliefert (Datum)</label>
              <input id="s-angeliefert" type="date" class="input">
            </div>

            <div class="sm:col-span-2">
              <label class="block mb-1 text-xs opacity-80">Betriebsmittel</label>
              <input id="s-betriebsmittel" type="text" class="input" placeholder="Rollwagen X‚Ä¶">
            </div>
          </div>

          
          <div class="sm:col-span-2 flex items-center gap-2 mt-1">
            <input id="s-clothing3d" type="checkbox" class="h-4 w-4 accent-white/80">
            <label for="s-clothing3d" class="text-xs opacity-85">
              Bekleidung: 3D-Freistellen (Beta, optional ‚Äì braucht OpenAI API-Key)
            </label>
          </div>

          <div class="flex justify-end mt-3">
            <button id="btn-settings-save" class="btn btn-primary text-xs">Speichern</button>
          </div>
        </div>

        <div id="settings-mini" class="text-[11px] text-white/80 mb-3"></div>

        <!-- HAUPTMASKE -->
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-3">
          <div>
            <label class="block mb-1 text-xs opacity-80">Artikelnr. (min. 6-stellig)</label>
            <input id="f-artikelnr" type="number" inputmode="numeric" class="input" autocomplete="off" placeholder="z.B. 810233">
            <div id="artnr-hint" class="text-[11px] text-white/80 mt-1"></div>
          </div>
          <div>
            <label class="block mb-1 text-xs opacity-80">Menge</label>
            <input id="f-menge" type="number" class="input" value="1" min="1">
          </div>
          <div>
            <label class="block mb-1 text-xs opacity-80">Lagerort</label>
            <input id="f-lagerort" type="text" class="input" placeholder="z.B. (22) Haushalt/Freizeit 170">
          </div>
        </div>

        <input id="f-file-camera" type="file" accept="image/*" capture="environment" class="hidden">

        <input id="f-file-local" type="file" accept="image/*" class="hidden">

        <div class="thumb mb-2" id="thumb">
          <span class="text-xs text-white/70 text-center">Tippen, um Foto aufzunehmen / auszuw√§hlen</span>
        </div>

        <!-- (Listenpreis-Button ist rechts beim Preis-System) -->

        <div class="img-strip flex gap-2 overflow-x-auto pb-1" id="img-strip"></div>
        <div id="cover-label" class="text-[11px] text-white/80 mt-1"></div>
        <div id="photo-count" class="text-[11px] text-white/70 mt-1"></div>

        <div class="flex justify-end mt-2">
          <button id="btn-set-cover" type="button" class="btn btn-ghost text-xs hidden">‚≠ê Als Titelbild setzen</button>
        </div>

        <div class="flex flex-col gap-2 mt-3">
          <button id="btn-photo" class="btn btn-primary text-sm">
            <i data-lucide="camera" class="w-4 h-4"></i> Foto ausw√§hlen
          </button>

          <button id="btn-delete-photo" class="btn btn-ghost text-sm">
            <i data-lucide="trash-2" class="w-4 h-4"></i> Foto l√∂schen
          </button>

          <button id="btn-save" class="btn btn-ghost text-sm">
            <i data-lucide="save" class="w-4 h-4"></i> Artikel speichern
          </button>
        
          <button id="btn-delete-article" class="btn btn-danger text-sm hidden">
            <i data-lucide="trash" class="w-4 h-4"></i> Position l√∂schen
          </button>
</div>

        <div class="mt-3">
          <div id="status-pill" class="pill hidden"><span class="dot"></span><span id="status-pill-text">KI l√§uft‚Ä¶</span></div>
          <div id="status-text" class="text-[11px] text-white/80 mt-2">Bereit.</div>
          <div id="save-status" class="text-[11px] text-white/80 mt-1">Status: ‚Äì</div>
        </div>
      </section>

      <!-- RECHTS -->
      <section>
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-lg font-semibold">2. KI-Vorschlag</h2>
          <button id="btn-describe" class="btn btn-ghost text-xs">‚ö° KI neu berechnen</button>
        </div>

        <div class="mb-3">
          <label class="block mb-1 text-xs opacity-80">Bezeichnung</label>
          <input id="f-title" type="text" class="input" autocomplete="off">
        </div>

        <div class="mb-3">
          <label class="block mb-1 text-xs opacity-80">Beschreibung</label>
          <textarea id="f-desc"></textarea>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
          <div id="retail-wrap">
            <label class="block mb-1 text-xs opacity-80">Listenpreis (‚Ç¨)</label>
            <input id="f-retail" type="number" class="input">
          </div>
          <div id="ruf-wrap">
            <label class="block mb-1 text-xs opacity-80">Rufpreis</label>
            <input id="f-ruf" type="number" class="input">
          </div>
        </div>

        <div class="flex justify-end gap-2 mb-3 flex-wrap">
          <button id="btn-price-toggle" class="btn btn-ghost text-[11px]" type="button">Preis-System ausschalten</button>
          <button id="btn-toggle-retail" class="btn btn-ghost text-[11px]" type="button">Listenpreis ausblenden</button>
        </div>

        <label class="block mb-1 text-xs opacity-80">Zuletzt aufgenommene Artikel (je Mitarbeiter)</label>
        <div id="recent" class="text-[11px] text-slate-900 bg-white/90 rounded-xl p-2 max-h-48 overflow-y-auto"></div>

              </section>
    </div>
  </main>
</div>

<script>
const fArt = document.getElementById('f-artikelnr');
  const artHint = document.getElementById('artnr-hint');
  const fLager = document.getElementById('f-lagerort');
  const fMenge = document.getElementById('f-menge');

  const fFileCamera = document.getElementById('f-file-camera');
  const fFileLocal = document.getElementById('f-file-local');
  const thumb = document.getElementById('thumb');
  const imgStrip = document.getElementById('img-strip');
  const coverLabel = document.getElementById('cover-label');
  const photoCount = document.getElementById('photo-count');
  const btnSetCover = document.getElementById('btn-set-cover');

  const fTitle = document.getElementById('f-title');
  const fDesc = document.getElementById('f-desc');
  const fRetail = document.getElementById('f-retail');
  const fRuf = document.getElementById('f-ruf');

  const btnPhoto = document.getElementById('btn-photo');
  const btnDeletePhoto = document.getElementById('btn-delete-photo');
  const btnSave = document.getElementById('btn-save');
const btnDeleteArticle = document.getElementById('btn-delete-article');
  const btnDescribe = document.getElementById('btn-describe');
  const btnPriceToggle = document.getElementById('btn-price-toggle');
  const btnToggleRetail = document.getElementById('btn-toggle-retail');

  const retailWrap = document.getElementById('retail-wrap');
  const rufWrap = document.getElementById('ruf-wrap');

  const statusText = document.getElementById('status-text');
  const statusPill = document.getElementById('status-pill');
  const statusPillText = document.getElementById('status-pill-text');


  const saveStatusEl = document.getElementById('save-status');
  let _dirty = false;
  let _lastSnapshot = "";
  let _lastSavedAt = 0;

  function _snapshot(){
    // snapshot only of article-specific fields (not global defaults)
    return JSON.stringify({
      artikelnr: (fArt.value||"").trim(),
      lagerort: (fLager.value||"").trim(),
      menge: String(fMenge.value||""),
      titel: (fTitle.value||"").trim(),
      beschreibung: (fDesc.value||"").trim(),
      retail_price: String(fRetail.value||""),
      rufpreis: String(fRuf.value||""),
    });
  }

  function _setSaveStatus(text){
    if(!saveStatusEl) return;
    saveStatusEl.textContent = text || "Status: ‚Äì";
  }

  function _markClean(label){
    _dirty = false;
    _lastSnapshot = _snapshot();
    if(label) _setSaveStatus(label);
    else _setSaveStatus("‚úÖ Gespeichert");
  }

  function _markDirty(){
    // ignore while no valid article number is entered
    if(!validArtNr()) return;
    const snap = _snapshot();
    if(_lastSnapshot && snap === _lastSnapshot){
      // back to last saved state
      _dirty = false;
      _setSaveStatus("‚úÖ Gespeichert");
      return;
    }
    _dirty = true;
    _setSaveStatus("‚úèÔ∏è Nicht gespeichert");
  }

  // Warn on leaving with unsaved changes
  window.addEventListener('beforeunload', (e)=>{
    if(_dirty){
      e.preventDefault();
      e.returnValue = "";
    }
  });


  const recentEl = document.getElementById('recent');
  const toastWrap = document.getElementById('toast-wrap');

  let selectedImageUrl = "";
  let selectedFilename = "";

  // ‚öôÔ∏è Settings
  const SETTINGS_KEY = "MYAUKTION_SETTINGS_V1";
  const btnSettings = document.getElementById('btn-settings');
  const settingsPanel = document.getElementById('settings-panel');
  const settingsMini = document.getElementById('settings-mini');

  const sEinl = document.getElementById('s-einlieferer-id');
  const sMit  = document.getElementById('s-mitarbeiter');
  const sLagerstand = document.getElementById('s-lagerstand');
  const sClothing3d = document.getElementById('s-clothing3d');
  const sUebernehmen = document.getElementById('s-uebernehmen');
  const sAngeliefert = document.getElementById('s-angeliefert');
  const sBetriebsmittel = document.getElementById('s-betriebsmittel');
  const sSortiment = document.getElementById('s-sortiment');
  const btnSettingsSave = document.getElementById('btn-settings-save');

  function loadSettings(){
    try{
      const raw = localStorage.getItem(SETTINGS_KEY);
      const d = raw ? JSON.parse(raw) : {};
      return Object.assign({
        einlieferer_id: "22",
        mitarbeiter: "Jan",
        menge: 1,
        lagerstand: 1,
        uebernehmen: 1,
        angeliefert: "",
        betriebsmittel: "",
        sortiment: "",
        price_system_enabled: true,
        hide_listprice: false
      }, d || {});
    }catch(e){
      return {
        einlieferer_id:"22",
        mitarbeiter:"Jan",
        menge:1,
        lagerstand:1,
        uebernehmen:1,
        angeliefert:"",
        betriebsmittel:"",
        sortiment:"",
        price_system_enabled:true,
        hide_listprice:false
      };
    }
  }
  function saveSettings(s){ try{ localStorage.setItem(SETTINGS_KEY, JSON.stringify(s)); }catch(e){} }

  function settingsText(s){
    const parts=[];
    parts.push("Einl.: " + (s.einlieferer_id||"-"));
    parts.push("MA: " + (s.mitarbeiter||"-"));
    parts.push("Menge: " + (s.menge ?? 1));
    parts.push("LS: " + (s.lagerstand ?? 1));
    parts.push("√º: " + (s.uebernehmen ?? 1));
    if(s.angeliefert) parts.push("angel.: " + s.angeliefert);
    if(s.betriebsmittel) parts.push("BM: " + s.betriebsmittel);
    if(s.sortiment) parts.push("Sort: " + s.sortiment);
    parts.push((s.price_system_enabled===false) ? "Preis: AUS" : "Preis: AN");
    return parts.join(" ¬∑ ");
  }

  function applySettingsToUI(){
    const s = loadSettings();
    sEinl.value = s.einlieferer_id || "22";
    sMit.value = s.mitarbeiter || "Jan";
    sLagerstand.value = String(s.lagerstand ?? 1);
    sUebernehmen.value = String(s.uebernehmen ?? 1);
    sAngeliefert.value = s.angeliefert || "";
    sBetriebsmittel.value = s.betriebsmittel || "";
    if(sSortiment) sSortiment.value = s.sortiment || "";
    settingsMini.textContent = "Einstellungen: " + settingsText(s);
    // Main-Feld Menge √ºbernehmen
    try{ fMenge.value = String(s.menge ?? 1); }catch(e){}
  }

  function readSettingsFromUI(){
    const prev = loadSettings();
    // WICHTIG: Preis-Flags d√ºrfen NICHT verloren gehen, sonst ‚Äûspringen‚Äú die Buttons zur√ºck.
    return {
      ...prev,
      einlieferer_id: (sEinl.value||"").trim(),
      mitarbeiter: (sMit.value||"").trim(),
      menge: parseInt((fMenge?.value)||"1",10) || 1,
      lagerstand: parseInt(sLagerstand.value||"1",10) || 1,
      uebernehmen: parseInt(sUebernehmen.value||"1",10) || 1,
      angeliefert: (sAngeliefert.value||"").trim(),
      betriebsmittel: (sBetriebsmittel.value||"").trim(),
      sortiment: (sSortiment ? (sSortiment.value||"").trim() : (prev.sortiment||"")),
      // preserve flags explicitly (falls prev unvollst√§ndig ist)
      price_system_enabled: (prev.price_system_enabled !== false),
      hide_listprice: (prev.hide_listprice === true),
      clothing3d: !!(sClothing3d && sClothing3d.checked)
    };
  }

  function toggleSettings(){
    const open = settingsPanel.classList.contains('hidden');
    if(open){
      settingsPanel.classList.remove('hidden');
      // visuelles Feedback, damit man sofort sieht, dass es offen ist
      settingsPanel.classList.add('ring','ring-white/40','ring-offset-2','ring-offset-transparent');
      btnSettings.textContent='‚¨ÜÔ∏è Einstellungen';
    }else{
      settingsPanel.classList.add('hidden');
      settingsPanel.classList.remove('ring','ring-white/40','ring-offset-2','ring-offset-transparent');
      btnSettings.textContent='‚öôÔ∏è Einstellungen';
    }
  }

  function applyPriceMode(){
    const s = loadSettings();
    const enabled = (s.price_system_enabled !== false);
    const hideRetail = (s.hide_listprice === true);

    if(btnPriceToggle){
      btnPriceToggle.textContent = enabled ? "Preis-System ausschalten" : "Preis-System einschalten";
      btnPriceToggle.classList.toggle('btn-danger', !enabled);
      btnPriceToggle.classList.toggle('btn-ghost', enabled);
    }
    if(btnToggleRetail){
      // Button nur sinnvoll, wenn Preis-System AN ist
      btnToggleRetail.classList.toggle("hidden", !enabled);
      btnToggleRetail.textContent = hideRetail ? "Listenpreis einblenden" : "Listenpreis ausblenden";
      // rot, wenn Listenpreis gerade AUSGEBLENDET ist
      btnToggleRetail.classList.toggle('btn-danger', enabled && hideRetail);
      btnToggleRetail.classList.toggle('btn-ghost', !(enabled && hideRetail));
    }

    const retailVisible = (enabled && !hideRetail);

    if(retailWrap){
      retailWrap.classList.toggle("hidden", !retailVisible);
    }
    if(rufWrap){
      rufWrap.classList.toggle("sm:col-span-2", !retailVisible);
    }

    if(!retailVisible){
      fRetail.value = "";
      fRetail.classList.add("price-off");
    }else{
      fRetail.classList.remove("price-off");
    }

    if(!enabled){
      fRuf.value = "1";
      fRuf.classList.add("price-off");
    }else{
      fRuf.classList.remove("price-off");
    }
  }

  function renderRecent(items){
    if(!recentEl) return;
    if(!items || !items.length){
      recentEl.innerHTML = '<div class="opacity-70">Noch keine Artikel gefunden.</div>';
      return;
    }
    recentEl.innerHTML = items.map(it=>{
      const nr = (it.artikelnr||"");
      const title = (it.titel||"").replaceAll('<','&lt;').replaceAll('>','&gt;');
      const dt = it.updated_at ? new Date((it.updated_at||0)*1000).toLocaleString() : '';
      return `<div class="flex items-center justify-between gap-2 py-1 border-b border-slate-200/60">
        <div class="min-w-0">
          <div class="font-semibold truncate">${nr} <span class="font-normal opacity-80">${title}</span></div>
          <div class="text-[10px] opacity-70">${dt}</div>
        </div>
        <button class="btn btn-ghost text-[10px] px-2 py-1" type="button" data-edit="${nr}">Bearbeiten</button>
      </div>`;
    }).join('');
  }

async function refreshRecent(){
    if(!recentEl) return;
    const who = (sMitarbeiter?.value || "").trim();
    try{
      const res = await fetch('/api/recent_articles?mitarbeiter=' + encodeURIComponent(who) + '&limit=12');
      const j = await res.json();
      renderRecent(j.items||[]);
    }catch(e){
      recentEl.innerHTML = '<div class="opacity-70">Fehler beim Laden.</div>';
    }
  }

  function toast(msg){
    const el = document.createElement('div');
    el.className = 'toast';
    el.textContent = msg;
    toastWrap.appendChild(el);
    void el.offsetWidth;
    el.classList.add('show');
    setTimeout(()=>{ el.classList.remove('show'); setTimeout(()=>el.remove(),200); }, 1500);
  }
  function validArtNr(){
    const v = (fArt.value||"").trim();
    return /^\d{6,}$/.test(v);
  }
  function setPill(on, text){
    if(on){ statusPill.classList.remove('hidden'); statusPillText.textContent = text || "‚Ä¶"; }
    else { statusPill.classList.add('hidden'); }
  }

  async function refreshImages(){
    const art = (fArt.value||"").trim();
    if(!art) return;
    const res = await fetch('/api/images?artikelnr=' + encodeURIComponent(art));
    const j = await res.json();

    imgStrip.innerHTML = '';
    selectedImageUrl = "";
    selectedFilename = "";

    const files = (j.files||[]);
    const cover = (j.cover||"").trim();
    if(coverLabel){ coverLabel.textContent = cover ? ("‚≠ê Titelbild: " + cover) : "‚≠ê Titelbild: (automatisch)"; }
    if(photoCount){ photoCount.textContent = `üì∏ Fotos: ${files.length}`; }

    files.forEach((url, idx)=>{
      const img = document.createElement('img');
      img.src = url;

      // filename aus URL
      const fname = String(url).split('/').pop().split('?')[0];

      // cover markieren (erster in Liste ist ohnehin cover-first, aber zur Sicherheit)
      const isCover = (fname === cover) || (idx===0 && !cover && files.length);

      img.title = isCover ? "Titelbild" : "Bild";

      img.onclick = ()=>{
        selectedImageUrl = url;
        selectedFilename = fname;
        thumb.innerHTML = `<img src="${url}">`;

        // UI highlight
        [...imgStrip.querySelectorAll('img')].forEach(el=> el.style.outline = "");
        img.style.outline = "2px solid rgba(255,255,255,.85)";

        if(btnSetCover){
          btnSetCover.classList.toggle("hidden", !selectedFilename);
        }
      };

      if(isCover){
        // kleines Badge per outline (visuell leicht)
        img.style.border = "2px solid rgba(255,215,0,.95)";
        img.style.boxShadow = "0 0 0 3px rgba(0,0,0,.15)";
      }

      imgStrip.appendChild(img);
    });

    // Wenn vorhanden: erstes Bild automatisch anzeigen (damit man sofort sieht ob Upload/L√∂schen geklappt hat)
    if(files.length){
      const firstImg = imgStrip.querySelector('img');
      if(firstImg) firstImg.click();
    }else{
      thumb.innerHTML = `<div class="muted">Kein Foto</div>`;
      if(btnSetCover) btnSetCover.classList.add("hidden");
    if(photoCount){ photoCount.textContent = "üì∏ Fotos: 0"; }
    if(btnDeleteArticle) btnDeleteArticle.classList.add('hidden');
    }

    if(btnSetCover){
      btnSetCover.classList.add("hidden");
    }
  }


  async function refreshMeta(){
    const art = (fArt.value||"").trim();
    if(!art) return;
    const res = await fetch('/api/meta?artikelnr=' + encodeURIComponent(art));
    const j = await res.json();
    if(!j.ok) return;

    fTitle.value = j.titel || "";
    fDesc.value  = j.beschreibung || "";
    fRetail.value = (j.retail_price ?? "");
    fRuf.value    = (j.rufpreis ?? "");
    applyPriceMode();

    if(j.image){
      thumb.innerHTML = `<img src="${j.image}">`;
    }

    // Loaded from server -> treat as clean baseline
    try{
      const t = new Date().toLocaleTimeString();
      _markClean('üì• Geladen (' + t + ')');
    }catch(e){}
  }

  async function pollUntilDone(art, maxMs=18000){
    const start = Date.now();
    setPill(true, "KI berechnet ‚Ä¶");
    statusText.textContent = "KI berechnet ‚Ä¶";

    while(Date.now() - start < maxMs){
      const res = await fetch('/api/meta?artikelnr=' + encodeURIComponent(art));
      const j = await res.json();
      if(j.ok){
        if(j.ki_source === 'realtime'){
          fTitle.value = j.titel || "";
          fDesc.value  = j.beschreibung || "";
          fRetail.value = (j.retail_price ?? "");
          fRuf.value    = (j.rufpreis ?? "");
          applyPriceMode();
          setPill(false);
          statusText.textContent = "KI-Vorschlag √ºbernommen.";
          toast("KI fertig");
          try{ _markClean('ü§ñ KI √ºbernommen (' + new Date().toLocaleTimeString() + ')'); }catch(e){}
          return;
        }
      }
      await new Promise(r=>setTimeout(r, 700));
    }
    setPill(false);
    statusText.textContent = "KI dauert l√§nger ‚Äì du kannst trotzdem weitermachen.";
  }

  function updateArtnrHint(){
    if(!fArt.value){ artHint.textContent=""; return; }
    if(validArtNr()){
      artHint.textContent = "‚úì OK";
      artHint.className = "text-[11px] text-green-200 mt-1";
    }else{
      artHint.textContent = "‚ö† Artikelnummer muss mindestens 6-stellig sein.";
      artHint.className = "text-[11px] text-red-200 mt-1";
    }
  }

  // Foto ausw√§hlen (lokaler Ordner/Galerie) nur √ºber Button
  btnPhoto.onclick = ()=> fFileLocal.click();
  // Foto machen (Kamera) nur √ºber Tippen auf das Vorschau-Feld
  thumb.onclick = ()=> fFileCamera.click();

  fArt.addEventListener('input', ()=>{ updateArtnrHint(); /* artikelnr change resets dirty state */ });
  // √Ñnderungen am Artikel -> Status auf ‚Äûnicht gespeichert‚Äú
  ;[fLager,fMenge,fTitle,fDesc,fRetail,fRuf].forEach(el=>{
    if(!el) return;
    el.addEventListener('input', _markDirty);
    el.addEventListener('change', _markDirty);
  });
  

  fArt.addEventListener('blur', async ()=>{
    updateArtnrHint();
    if(!validArtNr()) return;
    await refreshImages();
    await refreshMeta();
  });

  btnDeletePhoto.onclick = async ()=>{
  if(!validArtNr()) return alert("Artikelnummer muss mindestens 6-stellig sein.");
  const art = (fArt.value||"").trim();

  // Wenn ein Bild ausgew√§hlt ist -> genau dieses l√∂schen, sonst letztes
  const hasSelected = !!(selectedFilename && selectedFilename.trim());

  const msg = hasSelected
    ? ("Ausgew√§hltes Foto wirklich l√∂schen?\\n\\n" + selectedFilename)
    : "Letztes Foto wirklich l√∂schen?";

  if(!confirm(msg)) return;

  if(hasSelected){
    const res = await fetch('/api/delete_image', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({artikelnr: art, filename: selectedFilename})
    });
    const j = await res.json();
    if(!res.ok || !j.ok){
      alert("L√∂schen Fehler: " + (j.error || res.status));
      return;
    }
  }else{
    const res = await fetch('/api/delete_last_image', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({artikelnr: art})
    });
    const j = await res.json();
    if(!res.ok || !j.ok){
      alert("L√∂schen Fehler: " + (j.error || res.status));
      return;
    }
  }

  toast("Foto gel√∂scht");
  await refreshImages();
  await refreshMeta();
};


  async function handleSelectedFile(file){
    if(!validArtNr()){
      alert("Artikelnummer muss mindestens 6-stellig sein.");
      if(fFileCamera) fFileCamera.value = "";
      if(fFileLocal) fFileLocal.value = "";
      return;
    }
    const art = (fArt.value||"").trim();
    if(!file) return;

    const reader = new FileReader();
    reader.onload = (ev)=> thumb.innerHTML = `<img src="${ev.target.result}">`;
    reader.readAsDataURL(file);

    const fd = new FormData();
    fd.append('file', file);
    fd.append('artikelnr', art);
    try{ const s = loadSettings(); fd.append('clothing3d', s.clothing3d ? '1':'0'); }catch(e){}

    toast("Upload startet ‚Ä¶");
    setPill(true, "Upload ‚Ä¶");

    const res = await fetch('/api/upload', { method:'POST', body: fd });
    const j = await res.json();
    if(!res.ok || !j.ok){
      setPill(false);
      alert("Upload Fehler: " + (j.error || res.status));
      return;
    }

    toast("Upload OK");
    toast("Foto hochgeladen");
    await refreshImages();
    await pollUntilDone(art, 18000);
  }

  if(fFileCamera){
    fFileCamera.addEventListener('change', async ()=>{
      const file = fFileCamera.files[0];
      // wichtig: danach resetten, damit gleiches Foto nochmal ausw√§hlbar ist
      fFileCamera.value = "";
      await handleSelectedFile(file);
    });
  }

  if(fFileLocal){
    fFileLocal.addEventListener('change', async ()=>{
      const file = fFileLocal.files[0];
      fFileLocal.value = "";
      await handleSelectedFile(file);
    });
  }

  btnDescribe.onclick = async ()=>{
    if(!validArtNr()) return alert("Artikelnummer muss mindestens 6-stellig sein.");
    const art = (fArt.value||"").trim();
    setPill(true, "Manuelle KI ‚Ä¶");
    const res = await fetch('/api/describe?artikelnr=' + encodeURIComponent(art));
    const j = await res.json();
    if(!res.ok || !j.ok){
      setPill(false);
      alert("KI Fehler: " + (j.error || res.status));
      return;
    }
    fTitle.value = j.title || "";
    fDesc.value = j.description || "";
    fRetail.value = (j.retail_price ?? "");
    fRuf.value = (j.rufpreis ?? "");
    applyPriceMode();
    setPill(false);
    toast("KI √ºbernommen");
    try{ _markClean('ü§ñ KI √ºbernommen (' + new Date().toLocaleTimeString() + ')'); }catch(e){}
  };
  function goNextArticle(){
    const cur = (fArt.value||"").trim();
    if(!/^[0-9]{1,}$/.test(cur)) return;
    const next = String(parseInt(cur,10) + 1);
    fArt.value = next;
    if(typeof updateArtnrHint === "function") updateArtnrHint();
    // Reset UI for next item (keep Lagerort + Settings)
    thumb.innerHTML = '<span class="text-xs text-white/70 text-center">Tippen, um Foto aufzunehmen / auszuw√§hlen</span>';
    imgStrip.innerHTML = "";
    if(fFileCamera) fFileCamera.value = "";
    if(fFileLocal) fFileLocal.value = "";
    fTitle.value = "";
    fDesc.value = "";
    fRetail.value = "";
    fRuf.value = "";
    selectedImageUrl = "";
    selectedFilename = "";
    if(btnSetCover) btnSetCover.classList.add("hidden");
    // Menge auf gespeicherten Default
    try{ const s = loadSettings(); fMenge.value = String(s.menge ?? 1); }catch(e){}
    // Settings beibehalten (Defaults bleiben)
    if(typeof applyPriceMode === "function") applyPriceMode();
    _dirty = false;
    _lastSnapshot = _snapshot();
    _setSaveStatus('Status: bereit');
    statusText.textContent = "Bereit.";
    try{ window.scrollTo({top:0, behavior:"smooth"});}catch(e){}
    fArt.focus();
  }



  
btnSave.onclick = async ()=>{
  if(btnSave.dataset.busy === "1") return;
  btnSave.dataset.busy = "1";

  // dezente Save-Animation (ohne Zeitverlust)
  const _oldHTML = btnSave.innerHTML;
  const _oldCls  = btnSave.className;
  btnSave.disabled = true;
  btnSave.style.pointerEvents = "none";
  btnSave.style.opacity = "0.75";
  btnSave.innerHTML = '<span class="inline-flex items-center gap-2"><span class="inline-block w-3 h-3 rounded-full border border-white/60 border-t-transparent animate-spin"></span>Speichere‚Ä¶</span>';

  try{

    if(!validArtNr()) return alert("Artikelnummer muss mindestens 6-stellig sein.");
        const art = (fArt.value||"").trim();
        const s = loadSettings();

        const mengeVal = parseInt((fMenge.value||"1"),10) || 1;

        const payload = {
          artikelnr: art,
          lagerort: (fLager.value||"").trim(),

          mitarbeiter: s.mitarbeiter,
          menge: mengeVal,
          lagerstand: s.lagerstand,
          uebernehmen: s.uebernehmen,
          einlieferer_id: s.einlieferer_id,
          angeliefert: s.angeliefert,
          betriebsmittel: s.betriebsmittel,
          sortiment_id: s.sortiment,
          sortiment: s.sortiment,
          einlieferer: s.einlieferer_id,

          price_system_enabled: (s.price_system_enabled !== false),
          retail_price: (s.price_system_enabled === false || s.hide_listprice === true) ? "" : (fRetail.value||""),
          rufpreis: (s.price_system_enabled === false) ? 1 : (fRuf.value||0),

          titel: (fTitle.value||"").trim(),
          beschreibung: (fDesc.value||"").trim(),
          reviewed: false
        };

        const res = await fetch('/api/save', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const j = await res.json();
        if(!res.ok || !j.ok){
          alert("Speichern Fehler: " + (j.error || res.status));
          return;
        }
        toast("Gespeichert");
        
        try{
          _dirty = false;
          _lastSnapshot = _snapshot();
          _lastSavedAt = Date.now();
          _setSaveStatus('‚úÖ Gespeichert (' + new Date().toLocaleTimeString() + ')');
        }catch(e){}
  

        // Felder die IMMER zur√ºckgesetzt werden sollen
        try{
          fMenge.value = "1";
          if(sLagerstand) sLagerstand.value = "1";
          if(sUebernehmen) sUebernehmen.value = "1";
          const s2 = loadSettings();
          s2.menge = 1; s2.lagerstand = 1; s2.uebernehmen = 1;
          saveSettings(s2);
          applySettingsToUI();
        }catch(e){}

        goNextArticle();
    // kurze ‚ÄûGespeichert‚Äú-Best√§tigung
    btnSave.innerHTML = '<span class="inline-flex items-center gap-2">‚úÖ Gespeichert</span>';
    btnSave.classList.add('save-pulse');
    setTimeout(()=>btnSave.classList.remove('save-pulse'), 650);
    setTimeout(()=>{ try{ btnSave.innerHTML = _oldHTML; }catch(e){} }, 650);

  } finally {
    // Doppelklick-Schutz: ganz kurz gesperrt lassen, f√ºhlt sich aber nicht langsam an
    setTimeout(()=>{
      btnSave.dataset.busy = "0";
      btnSave.disabled = false;
      btnSave.style.pointerEvents = "";
      btnSave.style.opacity = "";
      // falls irgendein Error vor "Gespeichert" passiert ist:
      if(btnSave.innerHTML.includes("Speichere")) btnSave.innerHTML = _oldHTML;
    }, 700);
  }
};

  window.addEventListener('DOMContentLoaded', ()=>{
    // Sortiment-Liste laden (Admin verwaltet)
    async function loadSortimente(){
      try{
        const res = await fetch('/api/sortimente');
        const j = await res.json();
        
const items = (j.items||[]);
if(sSortiment){
  const cur = (loadSettings().sortiment || "");
  sSortiment.innerHTML = '<option value="">(kein Sortiment)</option>' + items.map(x=>{
    const id = (x && (x.id ?? x.ID)) != null ? String(x.id ?? x.ID) : "";
    const name = String(x && (x.name ?? x.Name) ? (x.name ?? x.Name) : x).replaceAll('"','&quot;');
    return `<option value="${id}">${name}</option>`;
  }).join('');
          if(cur) sSortiment.value = cur;
        }
      }catch(e){}
    }

    if(window.lucide) lucide.createIcons();

    applySettingsToUI();
    applyPriceMode();
    loadSortimente();
    refreshRecent();
    try{ _setSaveStatus('Status: bereit'); }catch(e){}

    // Bearbeiten-Modus: aus Admin/Gesamtartikel kommend
    try{
      const qp = new URLSearchParams(window.location.search);
      const editId = (qp.get("edit") || "").trim();
      if(editId){
        fArt.value = editId;
        updateArtnrHint();
        refreshImages();
        refreshMeta();
        toast("Bearbeiten: " + editId);
        if(btnDeleteArticle) btnDeleteArticle.classList.remove('hidden');
        // Position l√∂schen (nur im Bearbeiten-Modus sichtbar)
        if(btnDeleteArticle){
          btnDeleteArticle.onclick = async ()=>{
            if(!validArtNr()) return alert("Artikelnummer muss mindestens 6-stellig sein.");
            const art = (fArt.value||"").trim();
            if(!confirm("Diese Position wirklich l√∂schen?\n\nArtikelNr: " + art)) return;

            const res = await fetch('/api/delete_article', {
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({artikelnr: art})
            });
            const j = await res.json();
            if(!res.ok || !j.ok){
              alert("Position l√∂schen Fehler: " + (j.error || res.status));
              return;
            }
            toast("Position gel√∂scht");
            try{ window.location.href = "/"; }catch(e){}
          };
        }

      }
    }catch(e){}


    if(btnSetCover){
      btnSetCover.onclick = async ()=>{
        if(!validArtNr()) return alert("Artikelnummer muss mindestens 6-stellig sein.");
        if(!selectedFilename) return toast("Bitte ein Bild ausw√§hlen");
        const art = (fArt.value||"").trim();
        const res = await fetch('/api/set_cover', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({artikelnr: art, filename: selectedFilename})
        });
        const j = await res.json();
        if(!res.ok || !j.ok){
          alert("Titelbild Fehler: " + (j.error || res.status));
          return;
        }
        toast("Titelbild gesetzt");
        await refreshImages();
      };
    }


    btnSettings.onclick = toggleSettings;

    if(sSortiment){
      sSortiment.onchange = ()=>{ const s=readSettingsFromUI(); saveSettings(s); applySettingsToUI(); };
    }

    btnSettingsSave.onclick = ()=>{
      const ns = readSettingsFromUI();
      saveSettings(ns);
      applySettingsToUI();
      settingsPanel.classList.add('hidden');
      btnSettings.textContent = "‚öôÔ∏è Einstellungen";
      toast("Einstellungen gespeichert");
    };

    btnPriceToggle.onclick = ()=>{
      if(typeof validArtNr === "function" && !validArtNr()){
        toast("Bitte zuerst eine g√ºltige Artikelnummer eingeben");
        return;
      }
      const s = loadSettings();
      s.price_system_enabled = (s.price_system_enabled === false) ? true : false;
      saveSettings(s);
      applySettingsToUI();
      applyPriceMode();
    };


    if(btnToggleRetail){
      btnToggleRetail.onclick = ()=>{
        if(typeof validArtNr === "function" && !validArtNr()){
          toast("Bitte zuerst eine g√ºltige Artikelnummer eingeben");
          return;
        }
        const s = loadSettings();
        s.hide_listprice = (s.hide_listprice === true) ? false : true;
        saveSettings(s);
        applySettingsToUI();
        applyPriceMode();
      };
    }

    // Wenn noch nie gesetzt: einmal √∂ffnen
    const s0 = loadSettings();
    if(!s0.mitarbeiter || !s0.einlieferer_id){
      settingsPanel.classList.remove('hidden');
      btnSettings.textContent = "‚¨ÜÔ∏è Einstellungen";
    }
  
// Letzte Artikel je Mitarbeiter
if(sMitarbeiter){
  sMitarbeiter.addEventListener('change', ()=>{
    const s = loadSettings();
    s.mitarbeiter = sMitarbeiter.value;
    saveSettings(s);
    refreshRecent();
  });
}
if(recentEl){
  recentEl.addEventListener('click', async (ev)=>{
    const btn = ev.target.closest('button[data-edit]');
    if(!btn) return;
    const nr = btn.getAttribute('data-edit') || "";
    if(!nr) return;
    fArt.value = nr;
    await refreshMeta();
    // optional: Bilder neu laden
    try{ await refreshImages(); }catch(e){}
    toast("Artikel geladen: " + nr);
  });
}
});
</script>
</body>
</html>