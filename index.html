<!doctype html>
<html lang="de">
<head>
  <!-- build:NEXT_ARTICLE_20251215_193134 -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>MyAuktion · Artikelaufnahme</title>

<!-- FAVICONS & APP ICONS -->
<link rel="icon" href="/static/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">

<link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">

<link rel="icon" type="image/png" sizes="192x192" href="/static/android-chrome-192x192.png">
<link rel="icon" type="image/png" sizes="512x512" href="/static/android-chrome-512x512.png">

<meta name="theme-color" content="#1d4ed8">

  <script defer src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root { color-scheme: light dark; }
    body{
      min-height:100vh;
      background:
        radial-gradient(1200px 600px at 80% -10%, #e7f1ff 0%, transparent 60%),
        linear-gradient(135deg,#0ea5e9,#1d4ed8 60%,#1e293b);
      color:#fff;
    }
    .glass{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.16);backdrop-filter:blur(12px)}
    .btn{padding:.55rem 1rem;border-radius:999px;font-weight:700;display:inline-flex;align-items:center;gap:.45rem}
    .btn-primary{background:#fff;color:#0f172a;box-shadow:0 8px 18px rgba(0,0,0,.2)}
    .btn-ghost{color:#fff;border:1px solid rgba(255,255,255,.35);background:transparent}
    .btn-danger{color:#fff;border:1px solid rgba(239,68,68,.85);background:rgba(239,68,68,.22)}
    .input, select{
      width:100%;padding:.55rem .9rem;border-radius:.75rem;background:rgba(255,255,255,.96);
      color:#0f172a;outline:none;border:1px solid transparent;font-size:.9rem
    }
    textarea{
      width:100%;min-height:140px;padding:.6rem .9rem;border-radius:.75rem;
      background:rgba(255,255,255,.96)!important;color:#0f172a!important;
      outline:none;border:1px solid transparent;font-size:.9rem;resize:vertical
    }
    .thumb{
      border-radius:1rem;border:1px dashed rgba(255,255,255,.4);
      min-height:190px;display:flex;align-items:center;justify-content:center;
      overflow:hidden;background:rgba(15,23,42,.35);cursor:pointer
    }
    .thumb img{max-width:100%;max-height:100%;display:block}
    .img-strip img{height:58px;border-radius:.75rem;border:1px solid rgba(255,255,255,.3);cursor:pointer}
    .pill{font-size:.75rem;padding:.2rem .6rem;border-radius:999px;border:1px solid rgba(255,255,255,.3);display:inline-flex;gap:.3rem;align-items:center}
    .dot{width:7px;height:7px;border-radius:999px;background:#22c55e}
    .toast-wrap{position:fixed;top:12px;right:12px;z-index:50;display:flex;flex-direction:column;gap:8px}
    .toast{background:#fff;color:#0f172a;border-radius:999px;padding:7px 12px;font-weight:700;box-shadow:0 10px 30px rgba(0,0,0,.18);opacity:0;transform:translateY(-6px) scale(.94);transition:.18s}
    .toast.show{opacity:1;transform:translateY(0) scale(1)}
    .price-off{border:2px solid rgba(239,68,68,.9)!important;background:rgba(254,242,242,.95)!important}
  </style>
</head>

<body class="text-white">
<div id="toast-wrap" class="toast-wrap"></div>

<div class="max-w-5xl mx-auto px-4 py-5 md:py-8">
  <header class="flex items-center justify-between gap-4 mb-6">
    <div class="flex items-center gap-3">
      <div class="w-11 h-11 rounded-full bg-white shadow-lg flex items-center justify-center overflow-hidden">
        <img src="/static/myauktion_logo.png" alt="MyAuktion" class="max-w-[34px] max-h-[34px]" onerror="this.style.display=\'none\'; this.parentElement.innerHTML=\'<span class=&quot;text-slate-900 font-black&quot;>MG</span>\'">
      </div>
      <div>
        <div class="text-xl md:text-2xl font-bold tracking-tight flex items-center gap-2">
          MyAuktion <span class="text-sm font-semibold opacity-90">· Artikelaufnahme</span>
        </div>
        <div class="text-xs md:text-sm text-white/80">BEI UNS BESTIMMST DU DEN PREIS!</div>
      </div>
    </div>
    <a href="/admin" class="underline text-sm opacity-90">Admin</a>
  </header>

  <main class="glass rounded-3xl p-4 md:p-6 shadow-xl">
    <div class="grid md:grid-cols-2 gap-5">
      <!-- LINKS -->
      <section>
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-lg font-semibold">1. Artikel erfassen</h2>
          <button id="btn-settings" type="button" class="btn btn-ghost text-xs">⚙️ Einstellungen</button>
        </div>

        <!-- ⚙️ EINSTELLUNGEN -->
        <div id="settings-panel" class="glass rounded-2xl p-3 mb-3 hidden">
          <div class="text-[11px] text-white/80 mb-2">
            Startwerte (werden gespeichert und bei jedem Artikel automatisch übernommen)
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div>
              <label class="block mb-1 text-xs opacity-80">Einlieferer-ID</label>
              <select id="s-einlieferer-id" class="input">
                <option value="22" selected>22</option>
                <option value="55">55</option>
                <option value="66">66</option>
                <option value="65461">65461</option>
              </select>
            </div>

            <div>
              <label class="block mb-1 text-xs opacity-80">Mitarbeiter</label>
              <select id="s-mitarbeiter" class="input">
                <option>Jan</option><option>Rene</option><option>Karin</option><option>Katharina</option>
                <option>Linda</option><option>Jasmin</option><option>Natascha</option><option>Gast1</option><option>Gast2</option><option>Gast3</option>
              </select>
            </div>            <div>
              <label class="block mb-1 text-xs opacity-80">Lagerstand</label>
              <input id="s-lagerstand" type="number" class="input" value="1" min="1">
            </div>

            <div>
              <label class="block mb-1 text-xs opacity-80">Übernehmen</label>
              <input id="s-uebernehmen" type="number" class="input" value="1" min="0">
            </div>

            <div>
              <label class="block mb-1 text-xs opacity-80">Angeliefert (Datum)</label>
              <input id="s-angeliefert" type="date" class="input">
            </div>

            <div class="sm:col-span-2">
              <label class="block mb-1 text-xs opacity-80">Betriebsmittel</label>
              <input id="s-betriebsmittel" type="text" class="input" placeholder="Rollwagen X…">
            </div>
          </div>

          <div class="flex justify-end mt-3">
            <button id="btn-settings-save" class="btn btn-primary text-xs">Speichern</button>
          </div>
        </div>

        <div id="settings-mini" class="text-[11px] text-white/80 mb-3"></div>

        <!-- HAUPTMASKE -->
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-3">
          <div>
            <label class="block mb-1 text-xs opacity-80">Artikelnr. (min. 6-stellig)</label>
            <input id="f-artikelnr" type="number" inputmode="numeric" class="input" autocomplete="off" placeholder="z.B. 810233">
            <div id="artnr-hint" class="text-[11px] text-white/80 mt-1"></div>
          </div>
          <div>
            <label class="block mb-1 text-xs opacity-80">Menge</label>
            <input id="f-menge" type="number" class="input" value="1" min="1">
          </div>
          <div>
            <label class="block mb-1 text-xs opacity-80">Lagerort</label>
            <input id="f-lagerort" type="text" class="input" placeholder="z.B. (22) Haushalt/Freizeit 170">
          </div>
        </div>

        <input id="f-file" type="file" accept="image/*" capture="environment" class="hidden">

        <div class="thumb mb-2" id="thumb">
          <span class="text-xs text-white/70 text-center">Tippen, um Foto aufzunehmen / auszuwählen</span>
        </div>

        <!-- (Listenpreis-Button ist rechts beim Preis-System) -->

        <div class="img-strip flex gap-2 overflow-x-auto pb-1" id="img-strip"></div>

        <div class="flex justify-end mt-2">
          <button id="btn-set-cover" type="button" class="btn btn-ghost text-xs hidden">⭐ Als Titelbild setzen</button>
        </div>

        <div class="flex flex-col gap-2 mt-3">
          <button id="btn-photo" class="btn btn-primary text-sm">
            <i data-lucide="camera" class="w-4 h-4"></i> Foto auswählen
          </button>

          <button id="btn-delete-photo" class="btn btn-ghost text-sm">
            <i data-lucide="trash-2" class="w-4 h-4"></i> Foto löschen
          </button>

          <button id="btn-save" class="btn btn-ghost text-sm">
            <i data-lucide="save" class="w-4 h-4"></i> Artikel speichern
          </button>
        </div>

        <div class="mt-3">
          <div id="status-pill" class="pill hidden"><span class="dot"></span><span id="status-pill-text">KI läuft…</span></div>
          <div id="status-text" class="text-[11px] text-white/80 mt-2">Bereit.</div>
        </div>
      </section>

      <!-- RECHTS -->
      <section>
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-lg font-semibold">2. KI-Vorschlag</h2>
          <button id="btn-describe" class="btn btn-ghost text-xs">⚡ KI neu berechnen</button>
        </div>

        <div class="mb-3">
          <label class="block mb-1 text-xs opacity-80">Bezeichnung</label>
          <input id="f-title" type="text" class="input" autocomplete="off">
        </div>

        <div class="mb-3">
          <label class="block mb-1 text-xs opacity-80">Beschreibung</label>
          <textarea id="f-desc"></textarea>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
          <div id="retail-wrap">
            <label class="block mb-1 text-xs opacity-80">Listenpreis (€)</label>
            <input id="f-retail" type="number" class="input">
          </div>
          <div id="ruf-wrap">
            <label class="block mb-1 text-xs opacity-80">Rufpreis</label>
            <input id="f-ruf" type="number" class="input">
          </div>
        </div>

        <div class="flex justify-end gap-2 mb-3 flex-wrap">
          <button id="btn-price-toggle" class="btn btn-ghost text-[11px]" type="button">Preis-System ausschalten</button>
          <button id="btn-toggle-retail" class="btn btn-ghost text-[11px]" type="button">Listenpreis ausblenden</button>
        </div>

        <label class="block mb-1 text-xs opacity-80">System-Log</label>
        <div id="log" class="text-[11px] text-slate-900 bg-white/90 rounded-xl p-2 max-h-40 overflow-y-auto"></div>

              </section>
    </div>
  </main>
</div>

<script>
  const fArt = document.getElementById('f-artikelnr');
  const artHint = document.getElementById('artnr-hint');
  const fLager = document.getElementById('f-lagerort');
  const fMenge = document.getElementById('f-menge');

  const fFile = document.getElementById('f-file');
  const thumb = document.getElementById('thumb');
  const imgStrip = document.getElementById('img-strip');
  const btnSetCover = document.getElementById('btn-set-cover');

  const fTitle = document.getElementById('f-title');
  const fDesc = document.getElementById('f-desc');
  const fRetail = document.getElementById('f-retail');
  const fRuf = document.getElementById('f-ruf');

  const btnPhoto = document.getElementById('btn-photo');
  const btnDeletePhoto = document.getElementById('btn-delete-photo');
  const btnSave = document.getElementById('btn-save');
  const btnDescribe = document.getElementById('btn-describe');
  const btnPriceToggle = document.getElementById('btn-price-toggle');
  const btnToggleRetail = document.getElementById('btn-toggle-retail');

  const retailWrap = document.getElementById('retail-wrap');
  const rufWrap = document.getElementById('ruf-wrap');

  const statusText = document.getElementById('status-text');
  const statusPill = document.getElementById('status-pill');
  const statusPillText = document.getElementById('status-pill-text');

  const logEl = document.getElementById('log');
  const toastWrap = document.getElementById('toast-wrap');

  let selectedImageUrl = "";
  let selectedFilename = "";

  // ⚙️ Settings
  const SETTINGS_KEY = "MYAUKTION_SETTINGS_V1";
  const btnSettings = document.getElementById('btn-settings');
  const settingsPanel = document.getElementById('settings-panel');
  const settingsMini = document.getElementById('settings-mini');

  const sEinl = document.getElementById('s-einlieferer-id');
  const sMit  = document.getElementById('s-mitarbeiter');
  const sLagerstand = document.getElementById('s-lagerstand');
  const sUebernehmen = document.getElementById('s-uebernehmen');
  const sAngeliefert = document.getElementById('s-angeliefert');
  const sBetriebsmittel = document.getElementById('s-betriebsmittel');
  const btnSettingsSave = document.getElementById('btn-settings-save');

  function loadSettings(){
    try{
      const raw = localStorage.getItem(SETTINGS_KEY);
      const d = raw ? JSON.parse(raw) : {};
      return Object.assign({
        einlieferer_id: "22",
        mitarbeiter: "Jan",
        menge: 1,
        lagerstand: 1,
        uebernehmen: 1,
        angeliefert: "",
        betriebsmittel: "",
        price_system_enabled: true
        ,hide_listprice: false
      }, d || {});
    }catch(e){
      return {einlieferer_id:"22",mitarbeiter:"Jan",menge:1,lagerstand:1,uebernehmen:1,angeliefert:"",betriebsmittel:"",price_system_enabled:true};
    }
  }
  function saveSettings(s){ try{ localStorage.setItem(SETTINGS_KEY, JSON.stringify(s)); }catch(e){} }

  function settingsText(s){
    const parts=[];
    parts.push("Einl.: " + (s.einlieferer_id||"-"));
    parts.push("MA: " + (s.mitarbeiter||"-"));
    parts.push("Menge: " + (s.menge ?? 1));
    parts.push("LS: " + (s.lagerstand ?? 1));
    parts.push("ü: " + (s.uebernehmen ?? 1));
    if(s.angeliefert) parts.push("angel.: " + s.angeliefert);
    if(s.betriebsmittel) parts.push("BM: " + s.betriebsmittel);
    parts.push((s.price_system_enabled===false) ? "Preis: AUS" : "Preis: AN");
    return parts.join(" · ");
  }

  function applySettingsToUI(){
    const s = loadSettings();
    sEinl.value = s.einlieferer_id || "22";
    sMit.value = s.mitarbeiter || "Jan";
    sLagerstand.value = String(s.lagerstand ?? 1);
    sUebernehmen.value = String(s.uebernehmen ?? 1);
    sAngeliefert.value = s.angeliefert || "";
    sBetriebsmittel.value = s.betriebsmittel || "";
    settingsMini.textContent = "Einstellungen: " + settingsText(s);
    // Main-Feld Menge übernehmen
    try{ fMenge.value = String(s.menge ?? 1); }catch(e){}
  }

  function readSettingsFromUI(){
    const prev = loadSettings();
    return {
      einlieferer_id: (sEinl.value||"").trim(),
      mitarbeiter: (sMit.value||"").trim(),
      menge: parseInt((fMenge?.value)||"1",10) || 1,
      lagerstand: parseInt(sLagerstand.value||"1",10) || 1,
      uebernehmen: parseInt(sUebernehmen.value||"1",10) || 1,
      angeliefert: (sAngeliefert.value||"").trim(),
      betriebsmittel: (sBetriebsmittel.value||"").trim(),
      price_system_enabled: (prev.price_system_enabled !== false)
    };
  }

  function toggleSettings(){
    const open = settingsPanel.classList.contains('hidden');
    if(open){ settingsPanel.classList.remove('hidden'); btnSettings.textContent='⬆️ Einstellungen'; }
    else { settingsPanel.classList.add('hidden'); btnSettings.textContent='⚙️ Einstellungen'; }
  }

  function applyPriceMode(){
    const s = loadSettings();
    const enabled = (s.price_system_enabled !== false);
    const hideRetail = (s.hide_listprice === true);

    if(btnPriceToggle){
      btnPriceToggle.textContent = enabled ? "Preis-System ausschalten" : "Preis-System einschalten";
      btnPriceToggle.classList.toggle('btn-danger', !enabled);
      btnPriceToggle.classList.toggle('btn-ghost', enabled);
    }
    if(btnToggleRetail){
      // Button nur sinnvoll, wenn Preis-System AN ist
      btnToggleRetail.classList.toggle("hidden", !enabled);
      btnToggleRetail.textContent = hideRetail ? "Listenpreis einblenden" : "Listenpreis ausblenden";
      // rot, wenn Listenpreis gerade AUSGEBLENDET ist
      btnToggleRetail.classList.toggle('btn-danger', enabled && hideRetail);
      btnToggleRetail.classList.toggle('btn-ghost', !(enabled && hideRetail));
    }

    const retailVisible = (enabled && !hideRetail);

    if(retailWrap){
      retailWrap.classList.toggle("hidden", !retailVisible);
    }
    if(rufWrap){
      rufWrap.classList.toggle("sm:col-span-2", !retailVisible);
    }

    if(!retailVisible){
      fRetail.value = "";
      fRetail.classList.add("price-off");
    }else{
      fRetail.classList.remove("price-off");
    }

    if(!enabled){
      fRuf.value = "1";
      fRuf.classList.add("price-off");
    }else{
      fRuf.classList.remove("price-off");
    }
  }

  function log(msg){
    const t = new Date().toLocaleTimeString();
    const d = document.createElement('div');
    d.textContent = `[${t}] ${msg}`;
    logEl.prepend(d);
  }
  function toast(msg){
    const el = document.createElement('div');
    el.className = 'toast';
    el.textContent = msg;
    toastWrap.appendChild(el);
    void el.offsetWidth;
    el.classList.add('show');
    setTimeout(()=>{ el.classList.remove('show'); setTimeout(()=>el.remove(),200); }, 1500);
  }
  function validArtNr(){
    const v = (fArt.value||"").trim();
    return /^\d{6,}$/.test(v);
  }
  function setPill(on, text){
    if(on){ statusPill.classList.remove('hidden'); statusPillText.textContent = text || "…"; }
    else { statusPill.classList.add('hidden'); }
  }

  async function refreshImages(){
    const art = (fArt.value||"").trim();
    if(!art) return;
    const res = await fetch('/api/images?artikelnr=' + encodeURIComponent(art));
    const j = await res.json();

    imgStrip.innerHTML = '';
    selectedImageUrl = "";
    selectedFilename = "";

    const files = (j.files||[]);
    const cover = (j.cover||"").trim();

    files.forEach((url, idx)=>{
      const img = document.createElement('img');
      img.src = url;

      // filename aus URL
      const fname = String(url).split('/').pop();

      // cover markieren (erster in Liste ist ohnehin cover-first, aber zur Sicherheit)
      const isCover = (fname === cover) || (idx===0 && !cover && files.length);

      img.title = isCover ? "Titelbild" : "Bild";

      img.onclick = ()=>{
        selectedImageUrl = url;
        selectedFilename = fname;
        thumb.innerHTML = `<img src="${url}">`;

        // UI highlight
        [...imgStrip.querySelectorAll('img')].forEach(el=> el.style.outline = "");
        img.style.outline = "2px solid rgba(255,255,255,.85)";

        if(btnSetCover){
          btnSetCover.classList.toggle("hidden", !selectedFilename);
        }
      };

      if(isCover){
        // kleines Badge per outline (visuell leicht)
        img.style.border = "2px solid rgba(239,68,68,.75)";
      }

      imgStrip.appendChild(img);
    });

    if(btnSetCover){
      btnSetCover.classList.add("hidden");
    }
  }


  async function refreshMeta(){
    const art = (fArt.value||"").trim();
    if(!art) return;
    const res = await fetch('/api/meta?artikelnr=' + encodeURIComponent(art));
    const j = await res.json();
    if(!j.ok) return;

    fTitle.value = j.titel || "";
    fDesc.value  = j.beschreibung || "";
    fRetail.value = (j.retail_price ?? "");
    fRuf.value    = (j.rufpreis ?? "");
    applyPriceMode();

    if(j.image){
      thumb.innerHTML = `<img src="${j.image}">`;
    }
  }

  async function pollUntilDone(art, maxMs=18000){
    const start = Date.now();
    setPill(true, "KI berechnet …");
    statusText.textContent = "KI berechnet …";

    while(Date.now() - start < maxMs){
      const res = await fetch('/api/meta?artikelnr=' + encodeURIComponent(art));
      const j = await res.json();
      if(j.ok){
        if(j.ki_source === 'realtime'){
          fTitle.value = j.titel || "";
          fDesc.value  = j.beschreibung || "";
          fRetail.value = (j.retail_price ?? "");
          fRuf.value    = (j.rufpreis ?? "");
          applyPriceMode();
          setPill(false);
          statusText.textContent = "KI-Vorschlag übernommen.";
          toast("KI fertig");
          return;
        }
      }
      await new Promise(r=>setTimeout(r, 700));
    }
    setPill(false);
    statusText.textContent = "KI dauert länger – du kannst trotzdem weitermachen.";
  }

  function updateArtnrHint(){
    if(!fArt.value){ artHint.textContent=""; return; }
    if(validArtNr()){
      artHint.textContent = "✓ OK";
      artHint.className = "text-[11px] text-green-200 mt-1";
    }else{
      artHint.textContent = "⚠ Artikelnummer muss mindestens 6-stellig sein.";
      artHint.className = "text-[11px] text-red-200 mt-1";
    }
  }

  btnPhoto.onclick = ()=> fFile.click();
  thumb.onclick = ()=> fFile.click();

  fArt.addEventListener('input', updateArtnrHint);
  fMenge.addEventListener('change', ()=>{
    try{ const s=loadSettings(); s.menge = parseInt((fMenge.value||'1'),10)||1; saveSettings(s); applySettingsToUI(); }catch(e){}
  });

  fArt.addEventListener('blur', async ()=>{
    updateArtnrHint();
    if(!validArtNr()) return;
    await refreshImages();
    await refreshMeta();
  });

  btnDeletePhoto.onclick = async ()=>{
    if(!validArtNr()) return alert("Artikelnummer muss mindestens 6-stellig sein.");
    const art = (fArt.value||"").trim();
    if(!confirm("Letztes Foto wirklich löschen?")) return;
    const res = await fetch('/api/delete_last_image', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({artikelnr: art})
    });
    const j = await res.json();
    if(!res.ok || !j.ok){
      alert("Löschen Fehler: " + (j.error || res.status));
      return;
    }
    toast("Foto gelöscht");
    await refreshImages();
    await refreshMeta();
  };

  fFile.addEventListener('change', async ()=>{
    if(!validArtNr()){
      alert("Artikelnummer muss mindestens 6-stellig sein.");
      fFile.value = "";
      return;
    }
    const art = (fArt.value||"").trim();
    const file = fFile.files[0];
    if(!file) return;

    const reader = new FileReader();
    reader.onload = (ev)=> thumb.innerHTML = `<img src="${ev.target.result}">`;
    reader.readAsDataURL(file);

    const fd = new FormData();
    fd.append('file', file);
    fd.append('artikelnr', art);

    log("Upload startet …");
    setPill(true, "Upload …");

    const res = await fetch('/api/upload', { method:'POST', body: fd });
    const j = await res.json();
    if(!res.ok || !j.ok){
      setPill(false);
      alert("Upload Fehler: " + (j.error || res.status));
      return;
    }

    log("Upload OK: " + j.filename);
    toast("Foto hochgeladen");
    await refreshImages();
    await pollUntilDone(art, 18000);
  });

  btnDescribe.onclick = async ()=>{
    if(!validArtNr()) return alert("Artikelnummer muss mindestens 6-stellig sein.");
    const art = (fArt.value||"").trim();
    setPill(true, "Manuelle KI …");
    const res = await fetch('/api/describe?artikelnr=' + encodeURIComponent(art));
    const j = await res.json();
    if(!res.ok || !j.ok){
      setPill(false);
      alert("KI Fehler: " + (j.error || res.status));
      return;
    }
    fTitle.value = j.title || "";
    fDesc.value = j.description || "";
    fRetail.value = (j.retail_price ?? "");
    fRuf.value = (j.rufpreis ?? "");
    applyPriceMode();
    setPill(false);
    toast("KI übernommen");
  };
  function goNextArticle(){
    const cur = (fArt.value||"").trim();
    if(!/^[0-9]{1,}$/.test(cur)) return;
    const next = String(parseInt(cur,10) + 1);
    fArt.value = next;
    if(typeof updateArtnrHint === "function") updateArtnrHint();
    // Reset UI for next item (keep Lagerort + Settings)
    thumb.innerHTML = '<span class="text-xs text-white/70 text-center">Tippen, um Foto aufzunehmen / auszuwählen</span>';
    imgStrip.innerHTML = "";
    fFile.value = "";
    fTitle.value = "";
    fDesc.value = "";
    fRetail.value = "";
    fRuf.value = "";
    selectedImageUrl = "";
    selectedFilename = "";
    if(btnSetCover) btnSetCover.classList.add("hidden");
    // Menge auf gespeicherten Default
    try{ const s = loadSettings(); fMenge.value = String(s.menge ?? 1); }catch(e){}
    // Settings beibehalten (Defaults bleiben)
    if(typeof applyPriceMode === "function") applyPriceMode();
    statusText.textContent = "Bereit.";
    try{ window.scrollTo({top:0, behavior:"smooth"});}catch(e){}
    fArt.focus();
  }



  btnSave.onclick = async ()=>{
    if(!validArtNr()) return alert("Artikelnummer muss mindestens 6-stellig sein.");
    const art = (fArt.value||"").trim();
    const s = loadSettings();

    const mengeVal = parseInt((fMenge.value||"1"),10) || 1;

    // Menge (und Betriebsmittel etc.) als Default speichern, damit es beim nächsten Artikel gleich bleibt
    try{ s.menge = mengeVal; saveSettings(s); applySettingsToUI(); }catch(e){}

    const payload = {
      artikelnr: art,
      lagerort: (fLager.value||"").trim(),

      mitarbeiter: s.mitarbeiter,
      menge: mengeVal,
      lagerstand: s.lagerstand,
      uebernehmen: s.uebernehmen,
      einlieferer_id: s.einlieferer_id,
      angeliefert: s.angeliefert,
      betriebsmittel: s.betriebsmittel,
      einlieferer: s.einlieferer_id,

      price_system_enabled: (s.price_system_enabled !== false),
      retail_price: (s.price_system_enabled === false || s.hide_listprice === true) ? "" : (fRetail.value||""),
      rufpreis: (s.price_system_enabled === false) ? 1 : (fRuf.value||0),

      titel: (fTitle.value||"").trim(),
      beschreibung: (fDesc.value||"").trim(),
      reviewed: false
    };

    const res = await fetch('/api/save', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const j = await res.json();
    if(!res.ok || !j.ok){
      alert("Speichern Fehler: " + (j.error || res.status));
      return;
    }
    toast("Gespeichert");
    log("Gespeichert: " + art);
  
    goNextArticle();
};

  window.addEventListener('DOMContentLoaded', ()=>{
    if(window.lucide) lucide.createIcons();

    applySettingsToUI();
    applyPriceMode();

    if(btnSetCover){
      btnSetCover.onclick = async ()=>{
        if(!validArtNr()) return alert("Artikelnummer muss mindestens 6-stellig sein.");
        if(!selectedFilename) return toast("Bitte ein Bild auswählen");
        const art = (fArt.value||"").trim();
        const res = await fetch('/api/set_cover', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({artikelnr: art, filename: selectedFilename})
        });
        const j = await res.json();
        if(!res.ok || !j.ok){
          alert("Titelbild Fehler: " + (j.error || res.status));
          return;
        }
        toast("Titelbild gesetzt");
        await refreshImages();
      };
    }


    btnSettings.onclick = toggleSettings;

    btnSettingsSave.onclick = ()=>{
      const ns = readSettingsFromUI();
      saveSettings(ns);
      applySettingsToUI();
      settingsPanel.classList.add('hidden');
      btnSettings.textContent = "⚙️ Einstellungen";
      toast("Einstellungen gespeichert");
    };

    btnPriceToggle.onclick = ()=>{
      const s = loadSettings();
      s.price_system_enabled = (s.price_system_enabled === false) ? true : false;
      saveSettings(s);
      applySettingsToUI();
      applyPriceMode();
    };


    if(btnToggleRetail){
      btnToggleRetail.onclick = ()=>{
        const s = loadSettings();
        s.hide_listprice = (s.hide_listprice === true) ? false : true;
        saveSettings(s);
        applySettingsToUI();
        applyPriceMode();
      };
    }

    // Wenn noch nie gesetzt: einmal öffnen
    const s0 = loadSettings();
    if(!s0.mitarbeiter || !s0.einlieferer_id){
      settingsPanel.classList.remove('hidden');
      btnSettings.textContent = "⬆️ Einstellungen";
    }
  });
</script>
</body>
</html>
