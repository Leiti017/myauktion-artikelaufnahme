<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>MyAuktion · Artikelaufnahme</title>

  <link rel="icon" type="image/x-icon" href="/static/my_icon.ico">
  <script defer src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body{
      min-height:100vh;color:#fff;
      background:
        radial-gradient(900px 500px at 80% -10%, #e7f1ff 0%, transparent 60%),
        linear-gradient(135deg,#0ea5e9,#1d4ed8 60%,#1e293b);
    }
    .glass{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.16);backdrop-filter:blur(12px)}
    .input{width:100%;padding:.6rem .9rem;border-radius:.75rem;border:1px solid rgba(255,255,255,.3);background:#fff;color:#000;outline:none}
    textarea{width:100%;padding:.6rem .9rem;min-height:135px;border-radius:.75rem;border:1px solid rgba(255,255,255,.3);background:#fff !important;color:#000 !important;resize:vertical;outline:none}
    .btn{padding:.55rem 1rem;border-radius:999px;font-weight:600;display:inline-flex;align-items:center;gap:.4rem;cursor:pointer;transition:.2s}
    .btn-primary{background:#fff;color:#0f172a;box-shadow:0 8px 18px rgba(0,0,0,.2)}
    .btn-ghost{color:#fff;border:1px solid rgba(255,255,255,.4);background:transparent}
    .thumb{border:1px dashed rgba(255,255,255,.5);border-radius:1rem;min-height:180px;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.25);overflow:hidden;cursor:pointer}
    .thumb img{max-width:100%;max-height:100%}
    .status-pill{background:rgba(255,255,255,.9);color:#0f172a;font-size:.75rem;padding:.25rem .6rem;border-radius:999px;display:flex;align-items:center;gap:.35rem}
    .status-pill-dot{width:7px;height:7px;border-radius:999px;background:#22c55e}
    #toast-wrap{position:fixed;top:12px;right:12px;z-index:50;display:flex;flex-direction:column;gap:8px}
    .toast{background:#fff;color:#0f172a;padding:8px 14px;border-radius:999px;font-size:.85rem;font-weight:600;box-shadow:0 8px 22px rgba(0,0,0,.18);opacity:0;transform:translateY(-6px) scale(.95);transition:.2s}
    .toast.show{opacity:1;transform:translateY(0) scale(1)}
  </style>
</head>

<body>
<div id="toast-wrap"></div>

<div class="max-w-5xl mx-auto px-4 py-6">
  <header class="flex items-center justify-between mb-6">
    <div class="flex items-center gap-3">
      <div class="w-11 h-11 rounded-full bg-white overflow-hidden flex items-center justify-center shadow-lg">
        <img src="/static/myauktion_logo.png" class="max-w-[36px] max-h-[36px]">
      </div>
      <div>
        <div class="text-xl font-bold tracking-tight">MyAuktion · <span class="font-semibold">Artikelaufnahme</span></div>
        <div class="text-xs opacity-80">BEI UNS BESTIMMST DU DEN PREIS!</div>
      </div>
    </div>

    <!-- ✅ Admin-Link (war bei dir nicht drin) -->
    <a href="/admin" class="underline text-sm opacity-90">Admin Bereich</a>
  </header>

  <main class="glass rounded-3xl p-5 shadow-xl">
    <div class="grid md:grid-cols-2 gap-5">

      <!-- LINKS -->
      <section>
        <h2 class="text-lg font-semibold mb-3">1. Artikel erfassen</h2>

        <label class="opacity-80 text-xs">Artikelnummer (mind. 6-stellig)</label>
        <input id="f-artikelnr" type="number" class="input mb-3" placeholder="z. B. 810233" min="100000">

        <input id="f-file" type="file" accept="image/*" capture="environment" class="hidden">

        <div id="thumb" class="thumb mb-3">
          <span class="opacity-70 text-xs">Tippen für Foto…</span>
        </div>

        <button id="btn-photo" class="btn btn-primary w-full">
          <i data-lucide="camera" class="w-4 h-4"></i> Foto aufnehmen / auswählen
        </button>

        <div id="status-pill" class="status-pill hidden mt-3">
          <span class="status-pill-dot"></span>
          <span id="status-text">KI berechnet …</span>
        </div>

        <div id="ki-warning" class="text-red-200 bg-red-900/80 border border-red-400/60 rounded-xl px-3 py-2 text-xs hidden mt-3">
          ⚠️ KI aktuell nicht verfügbar – bitte Felder manuell ausfüllen.
        </div>
      </section>

      <!-- RECHTS -->
      <section>
        <h2 class="text-lg font-semibold mb-2">2. KI-Texte & Preis</h2>

        <label class="opacity-80 text-xs">Bezeichnung</label>
        <input id="f-title" type="text" class="input mb-3">

        <label class="opacity-80 text-xs">Beschreibung</label>
        <textarea id="f-desc" class="mb-3"></textarea>

        <!-- ✅ PREISFELDER (fehlten bei dir komplett) -->
        <label class="opacity-80 text-xs">KI-Listenpreis (€)</label>
        <input id="f-retail" type="number" step="0.01" class="input mb-3" readonly>

        <label class="opacity-80 text-xs">Auktions-Rufpreis (20%, aufgerundet)</label>
        <input id="f-ruf" type="number" step="0.01" class="input mb-3" readonly>

        <button id="btn-save" class="btn btn-primary w-full mb-2">
          <i data-lucide="save" class="w-4 h-4"></i> Artikel speichern
        </button>

        <button id="btn-describe" class="btn btn-ghost w-full">
          ⚡ KI neu berechnen (manuell)
        </button>
      </section>
    </div>

    <div class="mt-6">
      <label class="opacity-80 text-xs block mb-1">System-Log</label>
      <div id="log" class="bg-white text-slate-900 rounded-lg p-3 max-h-40 overflow-y-auto text-xs"></div>
    </div>
  </main>
</div>

<script>
  const fArt = document.getElementById("f-artikelnr");
  const fTitle = document.getElementById("f-title");
  const fDesc = document.getElementById("f-desc");
  const fRetail = document.getElementById("f-retail");
  const fRuf = document.getElementById("f-ruf");
  const fFile = document.getElementById("f-file");
  const thumb = document.getElementById("thumb");

  const btnSave = document.getElementById("btn-save");
  const btnPhoto = document.getElementById("btn-photo");
  const btnDescribe = document.getElementById("btn-describe");

  const statusPill = document.getElementById("status-pill");
  const statusText = document.getElementById("status-text");
  const warningEl = document.getElementById("ki-warning");
  const logEl = document.getElementById("log");
  const toastWrap = document.getElementById("toast-wrap");

  function log(msg){ const t=new Date().toLocaleTimeString(); logEl.innerHTML=`<div>[${t}] ${msg}</div>`+logEl.innerHTML; }
  function toast(msg){
    const el=document.createElement("div");
    el.className="toast"; el.textContent=msg;
    toastWrap.appendChild(el);
    requestAnimationFrame(()=>el.classList.add("show"));
    setTimeout(()=>{ el.classList.remove("show"); setTimeout(()=>el.remove(),200)},1800);
  }
  function isValidArtNr(){ return /^\d{6,}$/.test((fArt.value||"").trim()); }

  async function loadMeta(){
    const art=(fArt.value||"").trim();
    if(!art) return;
    const res=await fetch("/api/meta?artikelnr="+encodeURIComponent(art));
    const j=await res.json();
    if(!j.ok) return;

    fTitle.value = j.titel || "";
    fDesc.value  = j.beschreibung || "";
    fRetail.value= j.retail_price || "";
    fRuf.value   = j.rufpreis || "";

    if(j.image){ thumb.innerHTML = `<img src="${j.image}">`; }
    log("Meta geladen für Artikel " + art);
  }

  async function pollMetaUntilDone(art, maxSec=18){
    const start=Date.now();
    statusPill.classList.remove("hidden");
    statusText.textContent="KI berechnet …";
    warningEl.classList.add("hidden");

    while((Date.now()-start)<maxSec*1000){
      const res=await fetch("/api/meta?artikelnr="+encodeURIComponent(art));
      const j=await res.json();
      if(j.ok){
        if(j.ki_source==="realtime"){
          fTitle.value=j.titel||"";
          fDesc.value=j.beschreibung||"";
          fRetail.value=j.retail_price||"";
          fRuf.value=j.rufpreis||"";
          statusText.textContent="KI Vorschlag übernommen";
          warningEl.classList.add("hidden");
          return;
        }
        if(j.ki_source==="failed"){
          statusPill.classList.add("hidden");
          warningEl.classList.remove("hidden");
          return;
        }
      }
      await new Promise(r=>setTimeout(r,700));
    }
  }

  btnPhoto.onclick = ()=> fFile.click();
  thumb.onclick = ()=> fFile.click();

  fFile.addEventListener("change", async ()=>{
    if(!isValidArtNr()){
      alert("Artikelnummer muss mindestens 6-stellig sein.");
      return;
    }
    const art=(fArt.value||"").trim();
    const file=fFile.files[0];
    if(!file) return;

    const reader=new FileReader();
    reader.onload = ev => thumb.innerHTML = `<img src="${ev.target.result}">`;
    reader.readAsDataURL(file);

    const fd=new FormData();
    fd.append("file", file);
    fd.append("artikelnr", art);

    const res=await fetch("/api/upload",{method:"POST", body:fd});
    const j=await res.json();

    if(!res.ok || !j.ok){
      alert("Upload Fehler: " + (j.error||res.status));
      return;
    }
    toast("Foto hochgeladen");
    log("Upload OK");
    pollMetaUntilDone(art, 18);
  });

  btnDescribe.onclick = async ()=>{
    if(!isValidArtNr()){
      alert("Artikelnummer muss mindestens 6-stellig sein.");
      return;
    }
    const art=(fArt.value||"").trim();
    statusPill.classList.remove("hidden");
    statusText.textContent="KI Berechnung läuft …";
    warningEl.classList.add("hidden");

    const res=await fetch("/api/describe?artikelnr="+encodeURIComponent(art));
    const j=await res.json();

    if(!res.ok || !j.ok){
      statusPill.classList.add("hidden");
      warningEl.classList.remove("hidden");
      alert("KI Fehler: " + (j.error||res.status));
      return;
    }
    fTitle.value=j.title||"";
    fDesc.value=j.description||"";
    fRetail.value=j.retail_price||"";
    fRuf.value=j.rufpreis||"";
    statusText.textContent="KI Vorschlag übernommen";
    toast("KI-Vorschlag übernommen");
    log("KI manual OK");
  };

  btnSave.onclick = async ()=>{
    if(!isValidArtNr()){
      alert("Artikelnummer muss mindestens 6-stellig sein.");
      return;
    }
    const art=(fArt.value||"").trim();
    const body={artikelnr:art, titel:fTitle.value, beschreibung:fDesc.value};
    const res=await fetch("/api/save",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
    const j=await res.json();
    if(!res.ok||!j.ok){ alert("Fehler beim Speichern: "+(j.error||res.status)); return; }
    toast("Artikel gespeichert");
    log("Artikel gespeichert");
  };

  window.onload = ()=> { if(window.lucide) lucide.createIcons(); };
</script>
</body>
</html>
