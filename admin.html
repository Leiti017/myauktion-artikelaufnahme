<!doctype html>
<html lang="de">
<head>
    <!-- build:ADMIN_RANGE_FIX_20251216_062151 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>MyAuktion • Admin</title>
  <link rel="icon" type="image/x-icon" href="/static/my_icon.ico">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{min-height:100vh;background:linear-gradient(135deg,#0ea5e9,#1d4ed8 60%,#1e293b);color:#fff}
    .glass{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.16);backdrop-filter:blur(12px)}
    .input{width:100%;padding:.55rem .8rem;border-radius:.8rem;border:1px solid rgba(255,255,255,.35);background:#fff;color:#000}
    .btn{padding:.55rem 1rem;border-radius:999px;font-weight:700}
    .btn-primary{background:#fff;color:#0f172a;box-shadow:0 8px 18px rgba(0,0,0,.2)}
    .badge{font-size:.72rem;padding:.2rem .55rem;border-radius:999px}
    .bad-red{background:rgba(239,68,68,.18);border:1px solid rgba(239,68,68,.5);color:#fecaca}
    .bad-green{background:rgba(34,197,94,.18);border:1px solid rgba(34,197,94,.5);color:#bbf7d0}
    .bad-yellow{background:rgba(250,204,21,.18);border:1px solid rgba(250,204,21,.55);color:#fde68a}
  </style>
</head>
<body>
<div class="max-w-6xl mx-auto px-4 py-6">
  <header class="flex items-center justify-between mb-6">
    <div>
      <div class="text-2xl font-extrabold">MyAuktion · Admin</div>
      <div class="text-xs opacity-80">Budget, Flags, Überblick & CSV</div>
    </div>
    <div class="flex gap-2">
      <a href="/" class="underline text-sm opacity-90">Zur Artikelaufnahme</a>
    </div>
  </header>

  <div id="locked" class="glass rounded-3xl p-6 shadow-xl hidden">
    <div class="text-lg font-bold mb-2">Admin geschützt</div>
    <p class="text-sm opacity-90 mb-4">Bitte Admin-Token eingeben, damit Budget & Admin-Flags sichtbar sind.</p>
    <div class="grid md:grid-cols-3 gap-3 items-end">
      <div class="md:col-span-2">
        <label class="text-xs opacity-80">Admin-Token</label>
        <input id="token" class="input" placeholder="Token eingeben…">
      </div>
      <button id="btn-unlock" class="btn btn-primary w-full">Freischalten</button>
    </div>
    <p class="text-xs opacity-70 mt-3">Token wird lokal im Browser gespeichert (localStorage).</p>
  </div>

  <div id="content" class="hidden">
    <section class="glass rounded-3xl p-5 shadow-xl mb-5">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div>
          <div class="text-lg font-bold">KI Budget (geschätzt)</div>
          <div class="text-xs opacity-80">Schätzung basiert auf erfolgreichen KI-Aufrufen (fixer €/Call). OpenAI-Hardlimit steuerst du im Dashboard.</div>
        </div>
        <div class="flex gap-2">
          
<div class="glass rounded-2xl p-3 mb-3">
  <div class="text-sm font-semibold mb-2">CSV Export</div>
  <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
    <div>
      <label class="block text-xs opacity-80 mb-1">Von ArtikelNr</label>
      <input id="export-from" class="input" type="number" placeholder="z.B. 123458">
    </div>
    <div>
      <label class="block text-xs opacity-80 mb-1">Bis ArtikelNr</label>
      <input id="export-to" class="input" type="number" placeholder="z.B. 123480">
    </div>
    <div class="flex items-end gap-2">
      <button id="btn-export-range" class="btn btn-primary text-sm" type="button">Bereich exportieren</button>
      <a href="/api/export.csv" id="btn-export-all" class="btn btn-primary">CSV downloaden</a>
    </div>
  </div>
  <div class="text-[11px] opacity-70 mt-2">Leer lassen = kompletter Export.</div>
</div>

    <section class="glass rounded-3xl p-5 shadow-xl">
      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <div class="text-lg font-bold">Artikel</div>
          <div class="text-xs opacity-80">KI failed (rot), reviewed (grün), manuell (gelb)</div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 w-full md:w-auto">
          <div>
            <label class="text-xs opacity-80">Kategorie</label>
            <select id="f-cat" class="input">
              <option value="">Alle</option>
              <option>Parfum</option><option>Kosmetik</option><option>Werkzeug</option><option>Elektronik</option>
              <option>Haushalt</option><option>Kleidung</option><option>Schmuck/Uhren</option><option>Spielzeug</option>
              <option>Bücher/Medien</option><option>Sonstiges</option>
            </select>
          </div>
          <div>
            <label class="text-xs opacity-80">Nur KI-Fehler</label>
            <select id="f-failed" class="input">
              <option value="0" selected>Nein</option>
              <option value="1">Ja</option>
            </select>
          </div>
          <div>
            <label class="text-xs opacity-80">Suche</label>
            <input id="f-q" class="input" placeholder="ArtikelNr / Titel…">
          </div>
        </div>
      </div>

      <div class="overflow-x-auto mt-4">
        <table class="w-full text-sm">
          <thead class="text-left opacity-90">
            <tr>
              <th class="py-2 pr-3">Bild</th>
              <th class="py-2 pr-3">ArtikelNr</th>
              <th class="py-2 pr-3">Kategorie</th>
              <th class="py-2 pr-3">Bezeichnung</th>
              <th class="py-2 pr-3">Listenpreis</th>
              <th class="py-2 pr-3">Rufpreis</th>
              <th class="py-2 pr-3">Status</th>
              <th class="py-2 pr-3">Fehler</th>
            </tr>
          </thead>
          <tbody id="rows" class="align-top"></tbody>
        </table>
      </div>
    </section>
  </div>
</div>

<script>
  const locked = document.getElementById('locked');
  const content = document.getElementById('content');
  const tokenInp = document.getElementById('token');
  const btnUnlock = document.getElementById('btn-unlock');

  const bBudget = document.getElementById('b-budget');
  const bSpent = document.getElementById('b-spent');
  const bRemaining = document.getElementById('b-remaining');
  const bSuccess = document.getElementById('b-success');
  const bFail = document.getElementById('b-fail');
  const bLastErr = document.getElementById('b-lasterr');

  const rowsEl = document.getElementById('rows');
  const fCat = document.getElementById('f-cat');
  const fFailed = document.getElementById('f-failed');
  const fQ = document.getElementById('f-q');
  const btnRefresh = document.getElementById('btn-refresh');

function getToken(){
  // Safari/Privatmodus kann localStorage zicken -> zusätzlich Token per URL erlauben
  try{
    const qs = new URLSearchParams(location.search);
    const t = qs.get("t");
    if(t && t.length > 10){
      localStorage.setItem("MYAUKTION_ADMIN_TOKEN", t);
      return t;
    }
    return localStorage.getItem("MYAUKTION_ADMIN_TOKEN") || "";
  }catch(e){
    // Fallback: nur URL
    const qs = new URLSearchParams(location.search);
    return qs.get("t") || "";
  }
}
function setToken(t){
  try{ localStorage.setItem("MYAUKTION_ADMIN_TOKEN", t); }catch(e){}
}

  async function api(path){
    const t = getToken();
    const res = await fetch(path, { headers: t ? {"X-Admin-Token": t} : {} });
    if(res.status === 401) throw new Error("unauthorized");
    return res.json();
  }

  function money(v){ return (Math.round(v*100)/100).toFixed(2).replace(".", ",") + " €"; }
  function badge(text, cls){ return `<span class="badge ${cls}">${text}</span>`; }

  function renderRows(items){
    const q = (fQ.value || "").trim().toLowerCase();
    const filtered = items.filter(it=>{
      if(!q) return true;
      return (String(it.artikelnr).toLowerCase().includes(q) || String(it.titel).toLowerCase().includes(q));
    });

    rowsEl.innerHTML = filtered.map(it=>{
      const img = it.image ? `<img src="${it.image}" style="height:54px;border-radius:12px;border:1px solid rgba(255,255,255,.25)">` : '';
      const st = [];
      if(it.reviewed) st.push(badge("reviewed","bad-green"));
      if(it.ki_source === "failed") st.push(badge("KI failed","bad-red"));
      if(it.ki_source === "realtime") st.push(badge("KI ok","bad-green"));
      if(!it.ki_source || it.ki_source === "pending") st.push(badge(it.ki_source === "pending" ? "pending" : "manuell","bad-yellow"));

      return `
        <tr class="border-t border-white/15">
          <td class="py-2 pr-3">${img}</td>
          <td class="py-2 pr-3 font-bold">${it.artikelnr}</td>
          <td class="py-2 pr-3">${it.kategorie || ""}</td>
          <td class="py-2 pr-3">${(it.titel||"").replaceAll("<","&lt;")}</td>
          <td class="py-2 pr-3">${money(Number(it.retail_price||0))}</td>
          <td class="py-2 pr-3">${money(Number(it.rufpreis||0))}</td>
          <td class="py-2 pr-3">${st.join(" ")}</td>
          <td class="py-2 pr-3 text-xs opacity-90">${(it.ki_last_error||"")}</td>
        </tr>
      `;
    }).join("");
  }

  async function refresh(){
    const cat = (fCat.value || "").trim();
    const only_failed = fFailed.value || "0";
    const qs = new URLSearchParams();
    if(cat) qs.set("category", cat);
    if(only_failed === "1") qs.set("only_failed", "1");

    const budget = await api("/api/admin/budget");
    bBudget.textContent = money(budget.budget_eur);
    bSpent.textContent = money(budget.spent_est_eur);
    bRemaining.textContent = money(budget.remaining_est_eur);
    bSuccess.textContent = String(budget.success_calls);
    bFail.textContent = String(budget.failed_calls);
    bLastErr.textContent = budget.last_error || "—";

    const arts = await api("/api/admin/articles?" + qs.toString());
    renderRows(arts.items || []);
  }

  async function init(){
    const t = getToken();
    if(!t){
      locked.classList.remove("hidden");
      content.classList.add("hidden");
      return;
    }
    try{
      locked.classList.add("hidden");
      content.classList.remove("hidden");
      await refresh();
    }catch(e){
      locked.classList.remove("hidden");
      content.classList.add("hidden");
    }
  }

  btnUnlock.onclick = async ()=>{
    const t = (tokenInp.value || "").trim();
    if(!t) return;
    setToken(t);
    await init();
  };

  btnRefresh.onclick = refresh;
  fCat.onchange = refresh;
  fFailed.onchange = refresh;
  fQ.oninput = ()=> init();

  // CSV Export Bereich (Von/Bis)
  const btnExportRange = document.getElementById('btn-export-range');
  const exFrom = document.getElementById('export-from');
  const exTo = document.getElementById('export-to');

  if(btnExportRange){
    btnExportRange.addEventListener('click', ()=>{
      const a = exFrom ? String(exFrom.value||'').trim() : '';
      const b = exTo ? String(exTo.value||'').trim() : '';
      const params = new URLSearchParams();
      if(a) params.set('from_nr', a);
      if(b) params.set('to_nr', b);

      // Admin Token als Query mitschicken (Server prüft token=...)
      const t = getToken ? String(getToken()||'').trim() : '';
      if(t) params.set('token', t);

      const url = '/api/export.csv' + (params.toString() ? ('?' + params.toString()) : '');
      window.location.href = url;
    });
  }


  init();
</script>
</body>
</html>
