<!doctype html>
<html lang="de">
<head>
    <!-- build:ADMIN_EXPORT_NO_REFRESH_20251216_065009 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>MyAuktion • Admin</title>
  <link rel="icon" type="image/x-icon" href="/static/my_icon.ico">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{min-height:100vh;background:linear-gradient(135deg,#0ea5e9,#1d4ed8 60%,#1e293b);color:#fff}
    .glass{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.16);backdrop-filter:blur(12px)}
    .input{width:100%;padding:.55rem .8rem;border-radius:.8rem;border:1px solid rgba(255,255,255,.35);background:#fff;color:#000}
    .btn{padding:.55rem 1rem;border-radius:999px;font-weight:700}
    .btn-primary{background:#fff;color:#0f172a;box-shadow:0 8px 18px rgba(0,0,0,.2)}
    .badge{font-size:.72rem;padding:.2rem .55rem;border-radius:999px}
    .bad-red{background:rgba(239,68,68,.18);border:1px solid rgba(239,68,68,.5);color:#fecaca}
    .bad-green{background:rgba(34,197,94,.18);border:1px solid rgba(34,197,94,.5);color:#bbf7d0}
    .bad-yellow{background:rgba(250,204,21,.18);border:1px solid rgba(250,204,21,.55);color:#fde68a}
  </style>
</head>
<body>
<div class="max-w-6xl mx-auto px-4 py-6">
  <header class="flex items-center justify-between mb-6">
    <div>
      <div class="text-2xl font-extrabold">MyAuktion · Admin</div>
      <div class="text-xs opacity-80">Export, Sortimente & Artikel</div>
    </div>
    <div class="flex gap-2">
      <a href="/" class="underline text-sm opacity-90">Zur Artikelaufnahme</a>
    </div>
  </header>

  <div id="locked" class="glass rounded-3xl p-6 shadow-xl hidden">
    <div class="text-lg font-bold mb-2">Admin geschützt</div>
    <p class="text-sm opacity-90 mb-4">Bitte Admin-Token eingeben, damit Budget & Admin-Flags sichtbar sind.</p>
    <div class="grid md:grid-cols-3 gap-3 items-end">
      <div class="md:col-span-2">
        <label class="text-xs opacity-80">Admin-Token</label>
        <input id="token" class="input" placeholder="Passwort eingeben…">
      </div>
      <button id="btn-unlock" class="btn btn-primary w-full">Freischalten</button>
    </div>
    <p class="text-xs opacity-70 mt-3">Token wird lokal im Browser gespeichert (localStorage).</p>
  </div>

  <div id="content" class="hidden">
    <section class="glass rounded-3xl p-5 shadow-xl mb-5">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div>
          <div class="text-lg font-bold">CSV Export</div>
          <div class="text-xs opacity-80">Exportiere deine Artikel als Excel-kompatible CSV (mit Von/Bis Bereich).</div>
        </div>
        <div class="glass rounded-2xl p-3 mb-3">
  <div class="text-sm font-semibold mb-2">CSV Export</div>
  <div class="grid grid-cols-1 sm:grid-cols-4 gap-2">
    <div>
      <label class="block text-xs opacity-80 mb-1">Von ArtikelNr</label>
      <input id="export-from" class="input" type="number" placeholder="z.B. 123458">
    </div>
    <div>
      <label class="block text-xs opacity-80 mb-1">Bis ArtikelNr</label>
      <input id="export-to" class="input" type="number" placeholder="z.B. 123480">
    </div>
    <div>
      <label class="block text-xs opacity-80 mb-1">Sortiment</label>
      <select id="export-sortiment" class="input">
        <option value="">(alle)</option>
      </select>
    </div>

    <div class="flex items-end gap-2">
      <button id="btn-export-range" class="btn btn-primary w-full sm:w-auto" type="button">CSV exportieren</button>
      <button id="btn-export-images" class="btn btn-primary w-full sm:w-auto" type="button">Bilder ZIP</button>
    </div>
  </div>
  <div class="text-[11px] opacity-70 mt-2">Leer lassen = kompletter Export.</div>
  <div class="mt-4">
    <div class="flex items-center justify-between gap-2 mb-2">
      <div class="text-sm font-semibold">Artikel im ausgewählten Sortiment</div>
      <button id="btn-export-show" class="btn w-full sm:w-auto" type="button">Anzeigen</button>
    </div>
    <div id="export-sortiment-results" class="max-h-72 overflow-auto rounded-2xl border border-white/10"></div>
    <div class="text-[11px] opacity-70 mt-2">Tipp: Für sehr viele Artikel zuerst filtern, dann CSV/Bilder downloaden.</div>
  </div>

</div>
      </div>
    </section>


    <section class="glass rounded-3xl p-5 shadow-xl mb-5">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div>
          <div class="text-lg font-bold">Sortiment verwalten</div>
          <div class="text-xs opacity-80">Anlegen / umbennen / löschen – bleibt gespeichert und ist in den Einstellungen auswählbar.</div>
        </div>
        <div class="flex gap-2 w-full md:w-auto">
          <input id="sort-add" class="input" placeholder="Name z.B. (22) Tiernahrung 45">
          <input id="sort-add-id" class="input" style="max-width:140px" placeholder="ID (optional)">
          <button id="btn-sort-add" class="btn btn-primary" type="button">Hinzufügen</button>
        </div>
      </div>
      <div id="sort-list" class="mt-3"></div>
    </section>
    <section id="artikel" class="glass rounded-3xl p-5 shadow-xl mb-5">
      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <div class="text-lg font-bold">Artikel (Gesamtübersicht)</div>
          <div class="text-xs opacity-80">Neueste zuerst · Filter nach Aufnahmedatum</div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-2 w-full md:w-auto">
          <div>
            <label class="text-xs opacity-80">Von</label>
            <input id="all-from" type="date" class="input">
          </div>
          <div>
            <label class="text-xs opacity-80">Bis</label>
            <input id="all-to" type="date" class="input">
          </div>
          <div class="flex items-end gap-2">
            <button id="btn-all-filter" class="btn btn-primary w-full" type="button">Filtern</button>
            <button id="btn-all-reset" class="btn btn-primary w-full" type="button">Reset</button>
          </div>
          <div class="flex items-end justify-end">
            <div id="all-count" class="text-sm opacity-90">–</div>
          </div>
        </div>
      </div>

      <div class="overflow-x-auto mt-4">
        <table class="w-full text-sm">
          <thead class="text-left opacity-90">
            <tr>
              <th class="py-2 pr-3">Bild</th>
              <th class="py-2 pr-3">Datum</th>
              <th class="py-2 pr-3">ArtikelNr</th>
              <th class="py-2 pr-3">Sortiment</th>
              <th class="py-2 pr-3">Bezeichnung</th>
              <th class="py-2 pr-3">Menge</th>
              <th class="py-2 pr-3">Rufpreis</th>
              <th class="py-2 pr-3">Lagerort</th>
              <th class="py-2 pr-3">Mitarbeiter</th>
              <th class="py-2 pr-3">Bearbeiten</th>
            </tr>
          </thead>
          <tbody id="all-rows" class="align-top"></tbody>
        </table>
      </div>
    </section>

    <section class="glass rounded-3xl p-5 shadow-xl">
      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <div class="text-lg font-bold">Artikel</div>
          <div class="text-xs opacity-80">KI failed (rot), reviewed (grün), manuell (gelb)</div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 w-full md:w-auto">
          <div>
            <label class="text-xs opacity-80">Sortiment</label>
            <select id="f-sort" class="input">
              <option value="">Alle</option>
            </select>
          </div>
          <div>
            <label class="text-xs opacity-80">Nur KI-Fehler</label>
            <select id="f-failed" class="input">
              <option value="0" selected>Nein</option>
              <option value="1">Ja</option>
            </select>
          </div>
          <div>
            <label class="text-xs opacity-80">Suche</label>
            <input id="f-q" class="input" placeholder="ArtikelNr / Titel…">
          </div>
        </div>
      </div>

      <div class="overflow-x-auto mt-4">
        <table class="w-full text-sm">
          <thead class="text-left opacity-90">
            <tr>
              <th class="py-2 pr-3">Bild</th>
              <th class="py-2 pr-3">ArtikelNr</th>
              <th class="py-2 pr-3">Sortiment</th>
              <th class="py-2 pr-3">Bezeichnung</th>
              <th class="py-2 pr-3">Listenpreis</th>
              <th class="py-2 pr-3">Rufpreis</th>
              <th class="py-2 pr-3">Status</th>
              <th class="py-2 pr-3">Fehler</th>
            </tr>
          </thead>
          <tbody id="rows" class="align-top"></tbody>
        </table>
      </div>
    </section>
  </div>
</div>

<script>
  const locked = document.getElementById('locked');
  const content = document.getElementById('content');
  const tokenInp = document.getElementById('token');
  const btnUnlock = document.getElementById('btn-unlock');

  const rowsEl = document.getElementById('rows');
  const fSort = document.getElementById('f-sort');
  const fFailed = document.getElementById('f-failed');
  const fQ = document.getElementById('f-q');

  // Gesamtübersicht (ehem. /articles)
  const allFrom = document.getElementById('all-from');
  const allTo = document.getElementById('all-to');
  const btnAllFilter = document.getElementById('btn-all-filter');
  const btnAllReset = document.getElementById('btn-all-reset');
  const allRows = document.getElementById('all-rows');
  const allCount = document.getElementById('all-count');

function getToken(){
  // Safari/Privatmodus kann localStorage zicken -> zusätzlich Token per URL erlauben
  try{
    const qs = new URLSearchParams(location.search);
    const t = qs.get("t");
    if(t && t.length > 10){
      localStorage.setItem("MYAUKTION_ADMIN_TOKEN", t);
      return t;
    }
    return localStorage.getItem("MYAUKTION_ADMIN_TOKEN") || "";
  }catch(e){
    // Fallback: nur URL
    const qs = new URLSearchParams(location.search);
    return qs.get("t") || "";
  }
}
function setToken(t){
  try{ localStorage.setItem("MYAUKTION_ADMIN_TOKEN", t); }catch(e){}
}

  async function api(path){
    const t = getToken();
    const res = await fetch(path, { headers: t ? {"X-Admin-Token": t} : {} });
    if(res.status === 401) throw new Error("unauthorized");
    return res.json();
  }

  function money(v){ return (Math.round(v*100)/100).toFixed(2).replace(".", ",") + " €"; }
  function moneyPlain(v){
    const n = Number(v||0);
    if(!n) return "";
    return (Math.round(n*100)/100).toFixed(2).replace(".", ",");
  }
  function dt(ts){
    const n = Number(ts||0);
    if(!n) return "";
    const d = new Date(n*1000);
    return d.toLocaleString();
  }
  function badge(text, cls){ return `<span class="badge ${cls}">${text}</span>`; }

  function renderAllRows(items){
    if(!allRows) return;
    allRows.innerHTML = (items||[]).map(it=>{
      const img = it.image ? `<img src="${it.image}" style="height:54px;border-radius:12px;border:1px solid rgba(255,255,255,.25)">` : '';
      return `
        <tr class="border-t border-white/15">
          <td class="py-2 pr-3">${img}</td>
          <td class="py-2 pr-3 text-xs opacity-90">${dt(it.created_at)}</td>
          <td class="py-2 pr-3 font-bold">${it.artikelnr}</td>
          <td class="py-2 pr-3">${(it.sortiment||"")}</td>
          <td class="py-2 pr-3">${String(it.titel||"").replaceAll("<","&lt;")}</td>
          <td class="py-2 pr-3">${it.menge ?? 1}</td>
          <td class="py-2 pr-3">${moneyPlain(it.rufpreis)}</td>
          <td class="py-2 pr-3">${String(it.lagerort||"").replaceAll("<","&lt;")}</td>
          <td class="py-2 pr-3">${(it.mitarbeiter||"")}</td>
          <td class="py-2 pr-3"><a class="underline" href="/?edit=${it.artikelnr}">Bearbeiten</a></td>
        </tr>
      `;
    }).join('');
  }

  async function loadAllArticles(){
    if(!allRows) return;
    const qs = new URLSearchParams();
    if(allFrom && allFrom.value) qs.set('date_from', allFrom.value);
    if(allTo && allTo.value) qs.set('date_to', allTo.value);
    const js = await api('/api/articles' + (qs.toString()?('?' + qs.toString()):''));
    const items = (js.items||[]);
    if(allCount) allCount.textContent = items.length + ' Artikel';
    renderAllRows(items);
  }

  function renderRows(items){
    const q = (fQ.value || "").trim().toLowerCase();
    const filtered = items.filter(it=>{
      if(!q) return true;
      return (String(it.artikelnr).toLowerCase().includes(q) || String(it.titel).toLowerCase().includes(q));
    });

    rowsEl.innerHTML = filtered.map(it=>{
      const img = it.image ? `<img src="${it.image}" style="height:54px;border-radius:12px;border:1px solid rgba(255,255,255,.25)">` : '';
      const st = [];
      if(it.reviewed) st.push(badge("reviewed","bad-green"));
      if(it.ki_source === "failed") st.push(badge("KI failed","bad-red"));
      if(it.ki_source === "realtime") st.push(badge("KI ok","bad-green"));
      if(!it.ki_source || it.ki_source === "pending") st.push(badge(it.ki_source === "pending" ? "pending" : "manuell","bad-yellow"));

      return `
        <tr class="border-t border-white/15">
          <td class="py-2 pr-3">${img}</td>
          <td class="py-2 pr-3 font-bold">${it.artikelnr}</td>
          <td class="py-2 pr-3">${it.sortiment || ""}</td>
          <td class="py-2 pr-3">${(it.titel||"").replaceAll("<","&lt;")}</td>
          <td class="py-2 pr-3">${money(Number(it.retail_price||0))}</td>
          <td class="py-2 pr-3">${money(Number(it.rufpreis||0))}</td>
          <td class="py-2 pr-3">${st.join(" ")}</td>
          <td class="py-2 pr-3 text-xs opacity-90">${(it.ki_last_error||"")}</td><td class=\"py-2 pr-3\"><a class=\"underline\" href=\"/?edit=${it.artikelnr}\">Bearbeiten</a></td>
        </tr>
      `;
    }).join("");
  }

  async function loadSortimente(){
    try{
      const js = await api("/api/admin/sortimente");
      const items = (js.items||[]);
      if(fSort){
        const cur = (fSort.value || "").trim();
        
fSort.innerHTML = '<option value="">Alle</option>' + items.map(x=>{
  const id = (x && (x.id ?? x.ID)) != null ? String(x.id ?? x.ID) : "";
  const name = String(x && (x.name ?? x.Name) ? (x.name ?? x.Name) : x).replaceAll('"','&quot;');
  return `<option value="${id}">${name}</option>`;
}).join('');
        if(cur) fSort.value = cur;
      }
      if(exSort){
        const cur2 = (exSort.value || '').trim();
        exSort.innerHTML = '<option value="">(alle)</option>' + items.map(x=>{
          const name = String(x && (x.name ?? x.Name) ? (x.name ?? x.Name) : x).replaceAll('"','&quot;');
          return `<option value="${name}">${name}</option>`;
        }).join('');
        if(cur2) exSort.value = cur2;
      }
      // auch Management Liste
      renderSortimente(items);
    }catch(e){}
  }

  function renderSortimente(items){
    const box = document.getElementById('sort-list');
    if(!box) return;
    box.innerHTML = (items||[]).map(x=>{
      const id = (x && (x.id ?? x.ID)) != null ? String(x.id ?? x.ID) : "";
      const name = String(x && (x.name ?? x.Name) ? (x.name ?? x.Name) : x);
      const safeName = name.replaceAll("<","&lt;");
      const safeId = id.replaceAll("<","&lt;");
      return `
        <div class="flex items-center justify-between gap-2 py-1 border-b border-white/10">
          <div class="text-sm min-w-0">
            <div class="truncate"><span class="opacity-80">Name:</span> ${safeName}</div>
            <div class="text-[11px] opacity-80"><span class="opacity-80">ID:</span> ${safeId}</div>
          </div>
          <div class="flex gap-2">
            <button class="btn btn-primary" style="padding:.25rem .5rem;font-size:11px" onclick="renameSortiment('${safeId.replaceAll("'","&#39;")}', '${safeName.replaceAll("'","&#39;")}')">Umbennen</button>
            <button class="btn btn-primary" style="padding:.25rem .5rem;font-size:11px" onclick="deleteSortiment('${safeId.replaceAll("'","&#39;")}', '${safeName.replaceAll("'","&#39;")}')">Löschen</button>
          </div>
        </div>
      `;
    }).join('');
  }

  async function addSortiment(){
    const inp = document.getElementById('sort-add');
    const name = (inp?.value || "").trim();
    const idInp = document.getElementById("sort-add-id");
    const sid = (idInp?.value || "").trim();
    if(!name) return;
    const payload = {name};
    if(sid) payload.id = sid;
    const r = await apiPost("/api/admin/sortimente/add", payload);
    if(r && r.ok === false){ alert("Fehler: " + (r.error||"unbekannt")); return; }
    if(r && r.item && r.item.id){ alert("Sortiment angelegt\n\nName: " + r.item.name + "\nID: " + r.item.id); }
    inp.value = "";
    if(idInp) idInp.value = "";
    await loadSortimente();
    await refresh();
  }

  async function renameSortiment(id, oldName){
    const nn = prompt("Neuer Name für Sortiment:", oldName);
    if(!nn) return;
    await apiPost("/api/admin/sortimente/rename", {id, new: nn});
    await loadSortimente();
    await refresh();
  }

  async function deleteSortiment(id, name){
    if(!confirm("Sortiment wirklich löschen?\n\n" + name)) return;
    await apiPost("/api/admin/sortimente/delete", {id});
    await loadSortimente();
    await refresh();
  }

  async function apiPost(path, data){
    const t = getToken();
    const res = await fetch(path, {
      method:'POST',
      headers: { 'Content-Type':'application/json', ...(t ? {'X-Admin-Token': t} : {}) },
      body: JSON.stringify(data||{})
    });
    if(res.status === 401) throw new Error("unauthorized");
    return res.json();
  }

  async function refresh(){
    const sortiment = (fSort.value || "").trim();
    const only_failed = fFailed.value || "0";
    const qs = new URLSearchParams();
    if(sortiment) qs.set("sortiment", sortiment);
    if(only_failed === "1") qs.set("only_failed", "1");

    const arts = await api("/api/admin/articles?" + qs.toString());
    renderRows(arts.items || []);

    // keine Budget-Ansicht mehr
  }


  async function init(){
    const t = getToken();
    if(!t){
      locked.classList.remove("hidden");
      content.classList.add("hidden");
      return;
    }
    try{
      locked.classList.add("hidden");
      content.classList.remove("hidden");

      await loadSortimente();
      await refresh();
      await loadAllArticles();
    }catch(e){
      locked.classList.remove("hidden");
      content.classList.add("hidden");
    }
  }


  const btnSortAdd = document.getElementById('btn-sort-add');
  if(btnSortAdd){ btnSortAdd.onclick = addSortiment; }

  btnUnlock.onclick = async ()=>{
    const t = (tokenInp.value || "").trim();
    if(!t) return;
    setToken(t);
    await init();
  };

  fSort.onchange = refresh;
  fFailed.onchange = refresh;
  fQ.oninput = ()=> refresh();

  if(btnAllFilter){ btnAllFilter.onclick = loadAllArticles; }
  if(btnAllReset){
    btnAllReset.onclick = ()=>{
      if(allFrom) allFrom.value = '';
      if(allTo) allTo.value = '';
      loadAllArticles();
    };
  }

  // CSV Export Bereich (Von/Bis)
  const btnExportRange = document.getElementById('btn-export-range');
  const exFrom = document.getElementById('export-from');
  const exTo = document.getElementById('export-to');
  const exSort = document.getElementById('export-sortiment');
  const btnExportShow = document.getElementById('btn-export-show');
  const exportResults = document.getElementById('export-sortiment-results');

  if(btnExportRange){
    btnExportRange.addEventListener('click', ()=>{
      const a = exFrom ? String(exFrom.value||'').trim() : '';
      const b = exTo ? String(exTo.value||'').trim() : '';
      const params = new URLSearchParams();
      if(a) params.set('from_nr', a);
      if(b) params.set('to_nr', b);
  const sn = exSort ? String(exSort.value||'').trim() : '';
      if(sn) params.set('sortiment_name', sn);

      // Admin Token als Query mitschicken (Server prüft token=...)
      const t = getToken ? String(getToken()||'').trim() : '';
      if(t) params.set('token', t);

      const url = '/api/export.csv' + (params.toString() ? ('?' + params.toString()) : '');
      window.location.href = url;
    });
  }




// Bilder ZIP Export Bereich (Von/Bis)
const btnExportImages = document.getElementById('btn-export-images');
if(btnExportImages){
  btnExportImages.addEventListener('click', ()=>{
    const a = exFrom ? String(exFrom.value||'').trim() : '';
    const b = exTo ? String(exTo.value||'').trim() : '';
    const params = new URLSearchParams();
    if(a) params.set('from_nr', a);
    if(b) params.set('to_nr', b);
      const sn = exSort ? String(exSort.value||'').trim() : '';
      if(sn) params.set('sortiment_name', sn);

    // Admin Token als Query mitschicken (Server prüft token=...)
    const t = getToken ? String(getToken()||'').trim() : '';
    if(t) params.set('token', t);

    const url = '/api/export_images.zip' + (params.toString() ? ('?' + params.toString()) : '');
    window.location.href = url;
  });
}

// Sortiment-Artikel anzeigen (für Download/Check)
const _esc = (s)=>String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
async function showSortimentArticles(){
  if(!exportResults) return;
  const sn = exSort ? String(exSort.value||'').trim() : '';
  exportResults.innerHTML = '<div class="p-3 text-sm opacity-80">Lade…</div>';
  try{
    if(!sn){
      exportResults.innerHTML = '<div class="p-3 text-sm opacity-80">Bitte zuerst ein Sortiment auswählen.</div>';
      return;
    }
    const params = new URLSearchParams();
    params.set('sortiment_name', sn);
    params.set('limit', '5000'); // groß genug für Praxis; bei Bedarf später paging
    const js = await api('/api/articles?' + params.toString());
    const items = (js.items||[]);
    if(!items.length){
      exportResults.innerHTML = '<div class="p-3 text-sm opacity-80">Keine Artikel gefunden.</div>';
      return;
    }
    exportResults.innerHTML = items.map(x=>{
      const nr = String(x.artikelnr||x.artikel_nr||x.nr||'');
      const title = String(x.titel||x.title||x.bez||'');
      const created = x.created_at ? new Date((Number(x.created_at)||0)*1000).toLocaleString() : '';
      return `<div class="flex items-center justify-between gap-2 px-3 py-2 border-b border-white/10">
        <div class="min-w-0">
          <div class="text-sm font-semibold truncate">${nr} <span class="opacity-70 font-normal">${title ? ('– ' + _esc(title)) : ''}</span></div>
          <div class="text-[11px] opacity-60">${created}</div>
        </div>
        <a class="btn btn-primary shrink-0" href="/?artikelnr=${encodeURIComponent(nr)}" target="_blank" rel="noreferrer">Öffnen</a>
      </div>`;
    }).join('');
  }catch(e){
    exportResults.innerHTML = '<div class="p-3 text-sm opacity-80">Fehler beim Laden.</div>';
  }
}
if(btnExportShow){
  btnExportShow.addEventListener('click', ()=>{ showSortimentArticles(); });
}
if(exSort){
  exSort.addEventListener('change', ()=>{ showSortimentArticles(); });
}

  init();
</script>
</body>
</html>
